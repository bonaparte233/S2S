# LLM 配置重构说明

## 概述

将前端的"LLM 供应商选择"改为"LLM 配置选择"，解决了用户选择供应商后忘记填写 API Key 和模型名称导致报错的问题。

## 主要变更

### 1. 数据库模型 (`web/ppt_generator/models.py`)

**新增字段**：
- `llm_config_choice`: 配置方式选择（预设/自定义）
- `llm_preset_config`: 外键关联到 `GlobalLLMConfig`，用于选择预设配置

**保留字段**（用于自定义配置）：
- `llm_provider`: LLM 供应商
- `llm_model`: 模型名称
- `llm_api_key`: API Key
- `llm_base_url`: 服务器地址

### 2. 表单 (`web/ppt_generator/forms.py`)

**新增字段**：
- `llm_config_choice`: 单选框（预设配置 / 自定义配置）
- `llm_preset_config`: 下拉选择框，显示所有可用的预设配置

### 3. 视图逻辑 (`web/ppt_generator/views.py`)

**配置读取优先级**：

1. **使用预设配置**（`llm_config_choice == "preset"`）：
   - 直接从 `llm_preset_config` 读取所有配置
   - 用户只需选择一个预设，无需填写任何其他信息

2. **使用自定义配置**（`llm_config_choice == "custom"`）：
   - 从表单字段读取自定义配置
   - 如果配置不完整（缺少 provider 或 api_key），回退到全局默认配置

### 4. 前端模板 (`web/templates/ppt_generator/index.html`)

**UI 结构**：

```
[ ] 使用大模型辅助生成

  ┌─ LLM 配置方式 ─────────────┐
  │ ○ 使用预设配置              │
  │ ○ 自定义配置                │
  └────────────────────────────┘

  ┌─ 预设配置区域 ─────────────┐
  │ [选择预设配置 ▼]            │
  │   - DeepSeek 默认配置       │
  │   - Taichu 多模态配置       │
  │   - GLM 配置                │
  └────────────────────────────┘

  ┌─ 自定义配置区域 ───────────┐
  │ [LLM 供应商 ▼]             │
  │ [模型名称]                  │
  │ [API Key]                   │
  │ [服务器地址]                │
  └────────────────────────────┘

  [自定义 Prompt（可选）]
```

**JavaScript 逻辑**：
- 根据单选框选择，动态显示/隐藏预设配置区域或自定义配置区域
- 默认显示预设配置区域

## 使用方法

### 管理员配置

1. 进入 Django Admin 后台
2. 在"全局 LLM 配置"中创建多个预设配置：
   - DeepSeek 配置
   - Taichu 多模态配置
   - GLM 配置
   - 本地部署配置
3. 设置其中一个为默认配置

### 普通用户使用

**方式 1：使用预设配置（推荐）**
1. 勾选"使用大模型辅助生成"
2. 选择"使用预设配置"
3. 从下拉框中选择一个预设配置
4. 点击生成

**方式 2：自定义配置（开发者/管理员）**
1. 勾选"使用大模型辅助生成"
2. 选择"自定义配置"
3. 填写 LLM 供应商、模型名称、API Key 等信息
4. 点击生成

## 优势

1. **用户友好**：普通用户只需选择预设配置，无需了解技术细节
2. **灵活性**：开发者和管理员仍可使用自定义配置
3. **避免错误**：预设配置包含完整信息，避免因缺少字段导致的错误
4. **集中管理**：管理员可以在后台统一管理所有 LLM 配置

## 数据库迁移

已生成迁移文件：`ppt_generator/migrations/0012_pptgeneration_llm_config_choice_and_more.py`

迁移内容：
- 添加 `llm_config_choice` 字段（默认值：`preset`）
- 添加 `llm_preset_config` 外键字段
- 更新 `GlobalLLMConfig` 的字段定义

## 兼容性

- 旧的生成记录会自动使用 `preset` 模式
- 如果没有预设配置，会回退到全局默认配置
- 自定义配置功能完全保留，向后兼容

