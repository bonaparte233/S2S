{% extends 'base.html' %}

{% block title %}æ¨¡æ¿å¯¼å‡º - S2S{% endblock %}

{% block content %}
<div class="page-header">
    <h2>ğŸ”§ æ¨¡æ¿å¯¼å‡ºå·¥å…·</h2>
    <p class="subtitle">ä¸Šä¼ PPTæ¨¡æ¿æ–‡ä»¶ï¼Œå¯¼å‡ºJSONæè¿°ï¼ˆå¼€å‘è€…åŠŸèƒ½ï¼‰</p>
</div>

<div class="card">
    <div class="card-header">
        <h3>ğŸ“¤ ä¸Šä¼ æ¨¡æ¿æ–‡ä»¶</h3>
    </div>
    <div class="card-body">
        <form id="exportForm" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-group">
                <label for="template_file" class="form-label required">
                    PPTæ¨¡æ¿æ–‡ä»¶
                </label>
                <div class="file-upload-wrapper">
                    <input type="file" id="template_file" name="template_file" accept=".pptx" required>
                    <span class="file-upload-label">é€‰æ‹©æ¨¡æ¿æ–‡ä»¶ (.pptx)</span>
                </div>
                <small class="form-help">ä¸Šä¼ PPTæ¨¡æ¿æ–‡ä»¶ä»¥ç”ŸæˆJSONæè¿°</small>
            </div>

            <div class="form-group">
                <label for="mode" class="form-label">å¯¼å‡ºæ¨¡å¼</label>
                <select id="mode" name="mode" class="form-control">
                    <option value="semantic">è¯­ä¹‰æ¨¡å¼ - ä»…å¯¼å‡ºå‘½åè§„èŒƒçš„å…ƒç´ ï¼ˆæ¨èï¼‰</option>
                    <option value="text">æ–‡æœ¬æ¨¡å¼ - å¯¼å‡ºæ‰€æœ‰å¯ç¼–è¾‘æ–‡æœ¬æ¡†</option>
                </select>
                <small class="form-help">è¯­ä¹‰æ¨¡å¼åªå¯¼å‡ºåŒ…å«"xxåŒº"ç­‰å‘½åçš„å…ƒç´ ï¼Œæ–‡æœ¬æ¨¡å¼å¯¼å‡ºæ‰€æœ‰æ–‡æœ¬æ¡†</small>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-large">
                    ğŸš€ å¯¼å‡ºJSON
                </button>
            </div>
        </form>
    </div>
</div>

<div id="resultCard" class="card" style="display: none; margin-top: var(--spacing-lg);">
    <div class="card-header">
        <h3>ğŸ“„ å¯¼å‡ºç»“æœ</h3>
    </div>
    <div class="card-body">
        <div id="resultContent"></div>
        <div class="form-actions" style="margin-top: var(--spacing-md);">
            <button id="downloadBtn" class="btn btn-success">
                ğŸ“¥ ä¸‹è½½JSONæ–‡ä»¶
            </button>
            <button id="copyBtn" class="btn btn-secondary">
                ğŸ“‹ å¤åˆ¶åˆ°å‰ªè´´æ¿
            </button>
        </div>
    </div>
</div>

<div id="errorCard" class="card" style="display: none; margin-top: var(--spacing-lg);">
    <div class="card-header">
        <h3>âŒ é”™è¯¯</h3>
    </div>
    <div class="card-body">
        <div id="errorContent" class="error-details"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('exportForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const resultCard = document.getElementById('resultCard');
        const errorCard = document.getElementById('errorCard');

        // Hide previous results
        resultCard.style.display = 'none';
        errorCard.style.display = 'none';

        try {
            const response = await fetch('{% url "export_template" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            const data = await response.json();

            if (response.ok) {
                // Show result
                const jsonStr = JSON.stringify(data, null, 2);
                document.getElementById('resultContent').innerHTML = `<pre>${jsonStr}</pre>`;
                resultCard.style.display = 'block';

                // Store JSON for download
                window.exportedJSON = jsonStr;
            } else {
                // Show error
                let errorMsg = data.error || 'å¯¼å‡ºå¤±è´¥';
                if (data.traceback) {
                    errorMsg += '\n\nè¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š\n' + data.traceback;
                }
                document.getElementById('errorContent').innerHTML = `<pre>${errorMsg}</pre>`;
                errorCard.style.display = 'block';
            }
        } catch (error) {
            document.getElementById('errorContent').innerHTML = `<pre>${error.message}</pre>`;
            errorCard.style.display = 'block';
        }
    });

    // Download JSON
    document.getElementById('downloadBtn').addEventListener('click', function () {
        const blob = new Blob([window.exportedJSON], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'template.json';
        a.click();
        URL.revokeObjectURL(url);
    });

    // Copy to clipboard
    document.getElementById('copyBtn').addEventListener('click', async function () {
        try {
            await navigator.clipboard.writeText(window.exportedJSON);
            alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        } catch (error) {
            alert('å¤åˆ¶å¤±è´¥ï¼š' + error.message);
        }
    });
</script>
{% endblock %}