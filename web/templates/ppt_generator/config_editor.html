{% extends 'base.html' %}
{% load static %}

{% block title %}é…ç½®æ¨¡æ¿ç¼–è¾‘ - å¼€å‘è€…å·¥å…·{% endblock %}

{% block extra_css %}
<style>
    .tool-header {
        display: flex;
        align-items: center;
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .tool-header-icon {
        width: 64px;
        height: 64px;
        border-radius: 16px;
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        flex-shrink: 0;
    }

    .tool-header-info h2 {
        margin: 0 0 var(--spacing-xs) 0;
    }

    .tool-header-info p {
        margin: 0;
        color: var(--text-secondary);
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.9rem;
        margin-bottom: var(--spacing-md);
        transition: color 0.2s;
    }

    .back-link:hover {
        color: var(--primary-color);
    }

    .upload-zone {
        border: 2px dashed var(--border-color);
        border-radius: var(--border-radius);
        padding: var(--spacing-xl);
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .upload-zone:hover {
        border-color: var(--primary-color);
        background: var(--bg-hover);
    }

    .upload-zone.dragover {
        border-color: var(--primary-color);
        background: var(--primary-light);
    }

    .editor-container {
        display: flex;
        gap: var(--spacing-lg);
        height: calc(100vh - 300px);
        min-height: 600px;
    }

    .page-list {
        width: 280px;
        flex-shrink: 0;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        overflow-y: auto;
        background: var(--bg-secondary);
    }

    .page-item {
        padding: var(--spacing-md);
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .page-item:hover {
        background: var(--bg-hover);
    }

    .page-item.active {
        background: var(--primary-color);
        color: white;
    }

    .page-item-title {
        font-weight: 600;
        margin-bottom: 4px;
    }

    .page-item-meta {
        font-size: 0.85rem;
        opacity: 0.8;
    }

    .edit-area {
        flex: 1;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: var(--spacing-lg);
        overflow-y: auto;
        background: white;
    }

    .field-editor {
        margin-bottom: var(--spacing-lg);
        padding: var(--spacing-md);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        background: var(--bg-secondary);
    }

    .field-name {
        font-weight: 600;
        margin-bottom: var(--spacing-sm);
        color: var(--primary-color);
    }

    .field-row {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-sm);
        align-items: center;
    }

    .field-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .field-input {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        font-size: 0.9rem;
    }

    .field-input:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    .checkbox-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* åµŒå…¥æ¨¡å¼æ ·å¼ */
    body.embedded-mode .navbar,
    body.embedded-mode .back-link,
    body.embedded-mode .tool-header,
    body.embedded-mode #uploadSection,
    body.embedded-mode #uploadAnotherBtn,
    body.embedded-mode #downloadEditedBtn,
    body.embedded-mode .form-actions {
        display: none !important;
    }

    body.embedded-mode .main-content {
        padding-top: 0 !important;
        margin-top: 0 !important;
    }

    body.embedded-mode .main-content>.container {
        max-width: 100%;
        padding: 0;
    }

    body.embedded-mode .editor-container {
        height: 100vh;
        min-height: auto;
    }

    body.embedded-mode #editorSection .card {
        margin: 0;
        border: none;
        box-shadow: none;
        border-radius: 0;
    }

    body.embedded-mode #editorSection .card-header {
        padding: 10px 15px;
        border-radius: 0;
    }

    body.embedded-mode #editorSection .card-body {
        padding: 0;
    }
</style>
{% endblock %}

{% block content %}
<a href="{% url 'developer_tools_page' %}" class="back-link">â† è¿”å›å¼€å‘è€…å·¥å…·</a>

<div class="tool-header">
    <div class="tool-header-icon">âœï¸</div>
    <div class="tool-header-info">
        <h2>é…ç½®æ¨¡æ¿ç¼–è¾‘</h2>
        <p>ä¸Šä¼ å·²æœ‰çš„ JSON é…ç½®æ¨¡æ¿è¿›è¡Œç¼–è¾‘ï¼Œè°ƒæ•´å­—æ®µå±æ€§ã€æ·»åŠ æç¤ºä¿¡æ¯</p>
    </div>
</div>

<div id="uploadSection">
    <div class="card">
        <div class="card-header">
            <h3>ğŸ“‚ ä¸Šä¼ é…ç½®æ¨¡æ¿ JSON</h3>
        </div>
        <div class="card-body">
            <div class="upload-zone" id="uploadZone">
                <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">ğŸ“„</div>
                <p style="font-size: 1.1rem; margin-bottom: var(--spacing-sm);">ç‚¹å‡»æˆ–æ‹–æ‹½ JSON æ–‡ä»¶åˆ°æ­¤å¤„</p>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">æ”¯æŒ .json æ ¼å¼çš„é…ç½®æ¨¡æ¿æ–‡ä»¶</p>
                <input type="file" id="jsonFile" accept=".json" style="display: none;">
            </div>
        </div>
    </div>
</div>

<div id="editorSection" style="display: none;">
    <div class="card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3>âœï¸ ç¼–è¾‘é…ç½®æ¨¡æ¿</h3>
            <div style="display: flex; gap: var(--spacing-sm);">
                <button id="aiEnrichBtn" class="btn btn-primary btn-small">ğŸ¤– AI ä¸€é”®å¡«å……</button>
                <button id="uploadAnotherBtn" class="btn btn-secondary btn-small">ğŸ“‚ ä¸Šä¼ å…¶ä»–æ–‡ä»¶</button>
            </div>
        </div>
        <div class="card-body" style="padding: 0;">
            <div class="editor-container">
                <div class="page-list" id="pageList"></div>
                <div class="edit-area" id="editArea">
                    <p style="color: var(--text-secondary); text-align: center; padding: var(--spacing-xl);">
                        è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªé¡µé¢å¼€å§‹ç¼–è¾‘</p>
                </div>
            </div>
        </div>
    </div>
    <div class="form-actions" style="margin-top: var(--spacing-lg);">
        <button id="downloadEditedBtn" class="btn btn-success btn-large">ğŸ“¥ ä¸‹è½½ç¼–è¾‘åçš„é…ç½®æ¨¡æ¿</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let templateData = null;
    let currentPageIndex = 0;
    let currentSessionId = null;
    let currentFileName = null;

    const uploadZone = document.getElementById('uploadZone');
    const jsonFileInput = document.getElementById('jsonFile');

    // è·å– CSRF Token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // åµŒå…¥æ¨¡å¼æ ‡è®°
    let embeddedMode = false;

    // ä¿å­˜ç¼–è¾‘ä¼šè¯
    async function saveEditSession() {
        if (!templateData || !currentSessionId) return;

        // è®¡ç®—è¿›åº¦
        let totalFields = 0;
        let filledFields = 0;
        templateData.ppt_pages.forEach(page => {
            const content = page.content || {};
            Object.keys(content).forEach(fieldName => {
                totalFields++;
                const field = content[fieldName];
                if (field.hint) filledFields++;
            });
        });

        try {
            await fetch('/developer-tools/edit-sessions/save/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    session_id: currentSessionId,
                    editor_type: 'config',
                    template_name: currentFileName || 'æœªå‘½åé…ç½®',
                    progress_data: {
                        total_count: totalFields,
                        named_count: filledFields,
                        page_count: templateData.ppt_pages.length,
                        template_data: templateData,
                        from_wizard: embeddedMode  // æ ‡è®°æ˜¯å¦æ¥è‡ªå‘å¯¼
                    },
                    thumbnail_url: null
                })
            });
        } catch (e) {
            console.error('ä¿å­˜ç¼–è¾‘ä¼šè¯å¤±è´¥:', e);
        }
    }

    // æ¢å¤ç¼–è¾‘ä¼šè¯
    async function restoreEditSession(sessionId) {
        try {
            const response = await fetch(`/developer-tools/edit-sessions/${sessionId}/`);
            const data = await response.json();

            // API è¿”å›çš„æ•°æ®ç»“æ„æ˜¯ { session: {..., progress_data: {...}}, exists: true }
            const session = data.session;
            const progressData = session?.progress_data;

            if (response.ok && data.exists && progressData?.template_data) {
                currentSessionId = sessionId;
                currentFileName = session.template_name;
                loadTemplateData(progressData.template_data);
                return true;
            } else {
                alert('ç¼–è¾‘ä¼šè¯å·²è¿‡æœŸæˆ–æ•°æ®ä¸å®Œæ•´');
                return false;
            }
        } catch (error) {
            alert('æ¢å¤ä¼šè¯å¤±è´¥: ' + error.message);
            return false;
        }
    }

    // æ£€æŸ¥ URL ä¸­æ˜¯å¦æœ‰è¦æ¢å¤çš„ä¼šè¯æˆ–åˆå§‹é…ç½®
    function checkRestoreSession() {
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session');
        const embedded = urlParams.get('embedded') === '1';

        // åµŒå…¥æ¨¡å¼ï¼šæ·»åŠ  class å¹¶è®¾ç½®æ ‡è®°
        if (embedded) {
            embeddedMode = true;
            document.body.classList.add('embedded-mode');
        }

        if (sessionId) {
            restoreEditSession(sessionId);
        }
    }

    // ç›‘å¬æ¥è‡ªçˆ¶çª—å£çš„æ¶ˆæ¯ï¼ˆç”¨äºå‘å¯¼ä¼ é€’é…ç½®æ•°æ®ï¼‰
    window.addEventListener('message', function (event) {
        if (event.data && event.data.type === 'loadConfig') {
            const config = event.data.config;
            const sessionId = event.data.sessionId;
            if (config) {
                currentSessionId = sessionId || generateUUID();
                currentFileName = 'å‘å¯¼ç”Ÿæˆçš„é…ç½®';
                loadTemplateData(config);
                saveEditSession();
            }
        }

        // å‘å¯¼è¯·æ±‚è·å–å½“å‰é…ç½®æ•°æ®
        if (event.data && event.data.type === 'getConfig') {
            if (templateData && window.parent !== window) {
                window.parent.postMessage({
                    type: 'configData',
                    config: templateData
                }, '*');
            }
        }
    });

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥
    checkRestoreSession();

    uploadZone.addEventListener('click', () => jsonFileInput.click());
    uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file && file.name.endsWith('.json')) loadJSONFile(file);
        else alert('è¯·ä¸Šä¼  .json æ ¼å¼çš„æ–‡ä»¶');
    });
    jsonFileInput.addEventListener('change', (e) => { if (e.target.files[0]) loadJSONFile(e.target.files[0]); });

    document.getElementById('uploadAnotherBtn').addEventListener('click', function () {
        document.getElementById('uploadSection').style.display = 'block';
        document.getElementById('editorSection').style.display = 'none';
        templateData = null;
        currentPageIndex = 0;
    });

    // ç”Ÿæˆ UUID
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function loadJSONFile(file) {
        currentFileName = file.name;
        currentSessionId = generateUUID();  // ç”Ÿæˆæ–°çš„ä¼šè¯ ID
        const reader = new FileReader();
        reader.onload = function (e) {
            try {
                loadTemplateData(JSON.parse(e.target.result));
                saveEditSession();  // ä¿å­˜ä¼šè¯
            }
            catch (error) { alert('JSON æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼š' + error.message); }
        };
        reader.readAsText(file);
    }

    function loadTemplateData(data) {
        templateData = data;
        document.getElementById('uploadSection').style.display = 'none';
        document.getElementById('editorSection').style.display = 'block';
        renderPageList();
        if (data.ppt_pages && data.ppt_pages.length > 0) selectPage(0);
    }

    function renderPageList() {
        const pageList = document.getElementById('pageList');
        pageList.innerHTML = '';
        templateData.ppt_pages.forEach((page, index) => {
            const pageItem = document.createElement('div');
            pageItem.className = 'page-item' + (index === currentPageIndex ? ' active' : '');
            const fieldCount = Object.keys(page.content || {}).length;
            pageItem.innerHTML = '<div class="page-item-title">' + page.page_type + '</div><div class="page-item-meta">é¡µç : ' + page.template_page_num + ' | å­—æ®µ: ' + fieldCount + '</div>';
            pageItem.addEventListener('click', () => selectPage(index));
            pageList.appendChild(pageItem);
        });
    }

    function selectPage(index) {
        currentPageIndex = index;
        document.querySelectorAll('.page-item').forEach((item, i) => item.classList.toggle('active', i === index));
        renderEditArea();
    }

    function renderEditArea() {
        const page = templateData.ppt_pages[currentPageIndex];
        const editArea = document.getElementById('editArea');
        let html = '<h3 style="margin-bottom: var(--spacing-lg);">' + page.page_type + ' <span style="color: var(--text-secondary); font-size: 0.9rem;">(é¡µç : ' + page.template_page_num + ')</span></h3>';
        html += '<div class="field-editor" style="background: var(--primary-light); border-color: var(--primary-color);"><div class="field-name" style="color: var(--primary-color);">ğŸ“ é¡µé¢è¯´æ˜ (notes)</div><textarea class="field-input" style="width: 100%; min-height: 80px; resize: vertical;" data-type="notes" placeholder="å¸®åŠ©å¤§æ¨¡å‹ç†è§£è¿™ä¸€é¡µçš„å…·ä½“ç”¨å¤„...">' + (page.meta?.notes || '') + '</textarea></div>';
        html += '<h4 style="margin: var(--spacing-lg) 0 var(--spacing-md) 0;">å­—æ®µé…ç½®</h4>';
        const content = page.content || {};
        Object.keys(content).forEach(fieldName => {
            const field = content[fieldName];
            html += '<div class="field-editor"><div class="field-name">' + fieldName + '</div>';
            html += '<div class="field-row"><div class="field-label">æç¤º (hint):</div><input type="text" class="field-input" value="' + (field.hint || '') + '" data-field="' + fieldName + '" data-prop="hint" placeholder="å¸®åŠ©å¤§æ¨¡å‹ç†è§£éœ€è¦å¡«ä»€ä¹ˆ..."></div>';
            html += '<div class="field-row"><div class="field-label">æ˜¯å¦å¿…å¡«:</div><div class="checkbox-wrapper"><input type="checkbox" ' + (field.required ? 'checked' : '') + ' data-field="' + fieldName + '" data-prop="required"><span style="font-size: 0.9rem;">å¿…å¡«å­—æ®µ</span></div></div>';
            html += '<div class="field-row"><div class="field-label">æœ€å¤§å­—æ•°:</div><input type="number" class="field-input" value="' + (field.max_chars || '') + '" data-field="' + fieldName + '" data-prop="max_chars" placeholder="æœ€å¤§å­—ç¬¦æ•°..." min="1"></div></div>';
        });
        editArea.innerHTML = html;
        editArea.querySelectorAll('input, textarea').forEach(input => input.addEventListener('change', handleFieldChange));
    }

    function handleFieldChange(e) {
        const input = e.target;
        const fieldName = input.dataset.field;
        const prop = input.dataset.prop;
        const type = input.dataset.type;
        if (type === 'notes') {
            if (!templateData.ppt_pages[currentPageIndex].meta) templateData.ppt_pages[currentPageIndex].meta = {};
            templateData.ppt_pages[currentPageIndex].meta.notes = input.value;
        } else if (fieldName && prop) {
            const page = templateData.ppt_pages[currentPageIndex];
            if (!page.content[fieldName]) page.content[fieldName] = {};
            if (input.type === 'checkbox') page.content[fieldName][prop] = input.checked;
            else if (input.type === 'number') page.content[fieldName][prop] = parseInt(input.value) || 0;
            else page.content[fieldName][prop] = input.value;
        }
        // ä¿å­˜ç¼–è¾‘ä¼šè¯
        saveEditSession();
    }

    document.getElementById('downloadEditedBtn').addEventListener('click', function () {
        const jsonStr = JSON.stringify(templateData, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'template_edited.json';
        a.click();
        URL.revokeObjectURL(url);
    });

    document.getElementById('aiEnrichBtn').addEventListener('click', async function () {
        if (!templateData) { alert('è¯·å…ˆä¸Šä¼ é…ç½®æ¨¡æ¿æ–‡ä»¶'); return; }
        const confirmed = confirm('âš ï¸ è­¦å‘Šï¼šAI ç”Ÿæˆçš„å†…å®¹å¯èƒ½ä¸å‡†ç¡®ï¼Œéœ€è¦äººå·¥å®¡æ ¸å’Œä¿®æ”¹ã€‚\n\næ­¤æ“ä½œå°†ä½¿ç”¨å¤§æ¨¡å‹è‡ªåŠ¨å¡«å……æ‰€æœ‰é¡µé¢çš„ hintã€requiredã€max_chars å’Œ notes å­—æ®µã€‚\n\næ˜¯å¦ç»§ç»­ï¼Ÿ');
        if (!confirmed) return;
        const btn = this;
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'ğŸ¤– AI å¡«å……ä¸­...';
        try {
            const response = await fetch('{% url "ai_enrich_template" %}', {
                method: 'POST',
                body: JSON.stringify(templateData),
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' }
            });
            if (response.ok) {
                templateData = await response.json();
                renderPageList();
                renderEditArea();
                alert('âœ… AI å¡«å……å®Œæˆï¼è¯·ä»”ç»†æ£€æŸ¥å¹¶ä¿®æ”¹ç”Ÿæˆçš„å†…å®¹ã€‚');
            } else {
                const error = await response.json();
                alert('âŒ AI å¡«å……å¤±è´¥ï¼š' + (error.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) { alert('âŒ AI å¡«å……å¤±è´¥ï¼š' + error.message); }
        finally { btn.disabled = false; btn.textContent = originalText; }
    });
</script>
{% endblock %}