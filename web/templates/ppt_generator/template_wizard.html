{% extends 'base.html' %}
{% load static %}

{% block title %}æ¨¡æ¿åˆ¶ä½œå‘å¯¼ - S2S{% endblock %}

{% block extra_css %}
<style>
    html,
    body {
        height: 100%;
        margin: 0;
        overflow: hidden;
    }

    .navbar {
        display: none !important;
    }

    .main-content {
        padding: 0 !important;
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
    }

    .main-content>.container {
        max-width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }

    .footer {
        display: none !important;
    }

    /* å‘å¯¼å®¹å™¨ */
    .wizard-container {
        flex: 1;
        background: var(--bg-color);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* é¡¶éƒ¨æ  */
    .wizard-header {
        height: 70px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 24px;
        flex-shrink: 0;
        color: white;
    }

    .wizard-header h2 {
        margin: 0;
        font-size: 1.4rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .wizard-header .back-btn {
        color: white;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 6px;
        opacity: 0.9;
    }

    .wizard-header .back-btn:hover {
        opacity: 1;
    }

    /* æ­¥éª¤æŒ‡ç¤ºå™¨ */
    .steps-indicator {
        background: white;
        padding: 20px 40px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: center;
        gap: 0;
        flex-shrink: 0;
    }

    .steps-indicator.hidden {
        display: none;
    }

    .step-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 20px;
        color: #999;
        font-size: 0.95rem;
    }

    .step-item.active {
        color: #667eea;
        font-weight: 600;
    }

    .step-item.completed {
        color: #22c55e;
    }

    .step-number {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }

    .step-item.active .step-number {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
    }

    .step-item.completed .step-number {
        background: #22c55e;
        color: white;
    }

    .step-connector {
        width: 60px;
        height: 2px;
        background: #e5e7eb;
        margin: 0 5px;
    }

    .step-connector.completed {
        background: #22c55e;
    }

    /* ä¸Šä¼ é˜¶æ®µæ ·å¼ */
    .upload-stage-indicator {
        background: white;
        padding: 20px 40px;
        border-bottom: 1px solid var(--border-color);
        text-align: center;
        flex-shrink: 0;
    }

    .upload-stage-indicator h3 {
        margin: 0;
        color: #667eea;
        font-size: 1.1rem;
    }

    /* æ­¥éª¤å†…å®¹åŒº */
    .step-content {
        flex: 1;
        overflow: auto;
        padding: 30px;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }

    .step-panel {
        display: none;
    }

    .step-panel.active {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
    }

    /* ä¸Šä¼ åŒºåŸŸ */
    .upload-zone {
        max-width: 600px;
        margin: 60px auto;
        padding: 60px;
        border: 3px dashed #d1d5db;
        border-radius: 16px;
        text-align: center;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
    }

    .upload-zone:hover {
        border-color: #667eea;
        background: #f8f9ff;
    }

    .upload-zone.dragover {
        border-color: #667eea;
        background: #eef2ff;
    }

    .upload-icon {
        font-size: 4rem;
        margin-bottom: 20px;
    }

    .upload-title {
        font-size: 1.3rem;
        color: #333;
        margin-bottom: 10px;
    }

    .upload-hint {
        color: #666;
        font-size: 0.95rem;
    }

    /* æ­¥éª¤å·¥å…·æ  */
    .wizard-step-toolbar {
        background: white;
        border-radius: 12px 12px 0 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .wizard-step-toolbar .btn-warning,
    .wizard-step-toolbar .btn-info {
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .wizard-step-toolbar .btn-warning {
        background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .wizard-step-toolbar .btn-info {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
    }

    .wizard-step-toolbar .btn-warning:hover {
        background: linear-gradient(135deg, #d97706, #b45309);
        transform: translateY(-1px);
    }

    .wizard-step-toolbar .btn-info:hover {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        transform: translateY(-1px);
    }

    .wizard-step-toolbar .btn-warning:disabled,
    .wizard-step-toolbar .btn-info:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
    }

    /* åµŒå…¥å¼ç¼–è¾‘å™¨å®¹å™¨ */
    .embedded-editor {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        flex: 1;
        min-height: 0;
        overflow: hidden;
    }

    /* å½“æœ‰å·¥å…·æ æ—¶è°ƒæ•´ç¼–è¾‘å™¨æ ·å¼ */
    .wizard-step-toolbar+.embedded-editor {
        border-radius: 0 0 12px 12px;
    }

    .embedded-editor iframe {
        width: 100%;
        height: 100%;
        border: none;
    }

    /* åº•éƒ¨æ“ä½œæ  */
    .wizard-footer {
        height: 70px;
        background: white;
        border-top: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 30px;
        flex-shrink: 0;
    }

    .btn-secondary {
        background: #6b7280;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
    }

    .btn-secondary:hover {
        background: #4b5563;
    }
</style>
{% endblock %}

{% block content %}
<div class="wizard-container">
    <!-- é¡¶éƒ¨æ  -->
    <div class="wizard-header">
        <a href="{% url 'developer_tools_page' %}" class="back-btn">
            <i class="fas fa-arrow-left"></i> è¿”å›
        </a>
        <h2>ğŸ§™â€â™‚ï¸ æ¨¡æ¿åˆ¶ä½œå‘å¯¼</h2>
        <div style="width: 80px;"></div>
    </div>

    <!-- ä¸Šä¼ é˜¶æ®µæŒ‡ç¤ºå™¨ï¼ˆä»…åœ¨ä¸Šä¼ é˜¶æ®µæ˜¾ç¤ºï¼‰ -->
    <div class="upload-stage-indicator" id="uploadStageIndicator">
        <h3>ğŸ“¤ ä¸Šä¼  PPT æ¨¡æ¿æ–‡ä»¶å¼€å§‹åˆ¶ä½œ</h3>
    </div>

    <!-- æ­¥éª¤å†…å®¹åŒº -->
    <div class="step-content">
        <!-- Step 1: ä¸Šä¼  PPT -->
        <div class="step-panel active" id="step-1">
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">ğŸ“¤</div>
                <div class="upload-title">ä¸Šä¼  PPT æ¨¡æ¿æ–‡ä»¶</div>
                <div class="upload-hint">æ”¯æŒ .pptx æ ¼å¼ï¼Œæ‹–æ‹½æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
                <input type="file" id="pptFileInput" accept=".pptx" style="display:none;">
            </div>
        </div>

        <!-- Step 2: å…ƒç´ å‘½å -->
        <div class="step-panel" id="step-2">
            <!-- å…ƒç´ å‘½åå·¥å…·æ  -->
            <div class="wizard-step-toolbar" id="step2Toolbar" style="display:none;">
                <button id="wizardAiAutoNameAllBtn" class="btn btn-warning" title="ä½¿ç”¨ AI é‡æ–°å‘½åæ‰€æœ‰é¡µé¢ï¼ˆè¦†ç›–ç°æœ‰å‘½åï¼‰">
                    ğŸ¤– AI ä¸€é”®å‘½å
                </button>
                <button id="wizardAiAutoFillBtn" class="btn btn-info" title="ä½¿ç”¨ AI è¡¥å…¨ç¼ºå¤±çš„é…ç½®ï¼ˆä¿ç•™ç°æœ‰å‘½åï¼‰">
                    âœ¨ AI æŸ¥æ¼è¡¥ç¼º
                </button>
                <span id="wizardAiProgress" style="margin-left: 15px; color: #666; display: none;"></span>
            </div>
            <div class="embedded-editor" id="pptEditorContainer">
                <div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;">
                    <div class="text-center">
                        <div style="font-size:3rem;margin-bottom:20px;">â³</div>
                        <div>æ­£åœ¨åŠ è½½ PPT ç¼–è¾‘å™¨...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: å‘å¸ƒæ¨¡æ¿ -->
        <div class="step-panel" id="step-3">
            <div style="max-width:600px;margin:60px auto;">
                <div style="background:white;border-radius:16px;padding:40px;box-shadow:0 2px 12px rgba(0,0,0,0.1);">
                    <div style="text-align:center;margin-bottom:30px;">
                        <div style="font-size:4rem;margin-bottom:15px;">ğŸš€</div>
                        <h3 style="margin:0;color:#333;">å‘å¸ƒæ¨¡æ¿åˆ°æ¨¡æ¿åº“</h3>
                        <p style="color:#666;margin-top:10px;">æ¨¡æ¿å°†ä¿å­˜åˆ° templates ç›®å½•ï¼Œå¯ç›´æ¥ç”¨äº PPT ç”Ÿæˆ</p>
                    </div>
                    <div style="margin-bottom:25px;">
                        <label style="display:block;margin-bottom:8px;font-weight:600;color:#333;">
                            æ¨¡æ¿åç§° <span style="color:#ef4444;">*</span>
                        </label>
                        <input type="text" id="templateName" class="form-control" placeholder="ä¾‹å¦‚ï¼šè¯¾ç¨‹ä»‹ç»æ¨¡æ¿ã€å®éªŒæŠ¥å‘Šæ¨¡æ¿"
                            style="font-size:1.1rem;padding:12px 16px;"
                            oninput="wizardState.templateName = this.value.trim()">
                        <small style="color:#666;margin-top:5px;display:block;">
                            åªèƒ½åŒ…å«ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œæ¨ªçº¿
                        </small>
                    </div>
                    <div id="publishStatus" style="margin-bottom:20px;display:none;"></div>
                    <button id="publishBtn" class="btn btn-lg w-100"
                        style="background:linear-gradient(135deg,#22c55e,#16a34a);color:white;border:none;padding:14px;">
                        <i class="fas fa-rocket"></i> å‘å¸ƒæ¨¡æ¿
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <div class="wizard-footer">
        <button id="prevBtn" class="btn btn-outline-secondary" style="display:none;">
            <i class="fas fa-arrow-left"></i> è¿”å›ç¼–è¾‘
        </button>
        <button id="nextBtn" class="btn btn-success" style="display:none;">
            <i class="fas fa-rocket"></i> å‘å¸ƒæ¨¡æ¿
        </button>
    </div>
</div>



{% endblock %}

{% block extra_js %}
<script>
    // å‘å¯¼çŠ¶æ€
    const wizardState = {
        currentStep: 1,
        pptSessionId: null,
        templateName: '',
        configData: null,
        wizardSessionId: null,
        existingSession: {% if existing_session_json %}JSON.parse('{{ existing_session_json|escapejs }}'){% else %} null{% endif %},
    editModeData: {% if edit_mode_data %} JSON.parse('{{ edit_mode_data|escapejs }}'){% else %} null{% endif %},
    isEditMode: false,
        originalTemplateName: null
    };

    // DOM å…ƒç´ ï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼‰
    let stepPanels, prevBtn, nextBtn, uploadZone, pptFileInput;

    // CSRF Token
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value
            || document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    }

    // åˆ‡æ¢æ­¥éª¤
    function goToStep(step) {
        if (step < 1 || step > 3) return;

        wizardState.currentStep = step;

        // åˆ‡æ¢ä¸Šä¼ é˜¶æ®µæŒ‡ç¤ºå™¨çš„æ˜¾ç¤º
        const uploadStageIndicator = document.getElementById('uploadStageIndicator');

        if (step === 1) {
            // ä¸Šä¼ é˜¶æ®µ
            uploadStageIndicator.style.display = 'block';
        } else {
            // ç¼–è¾‘/å‘å¸ƒé˜¶æ®µ
            uploadStageIndicator.style.display = 'none';
        }

        // æ˜¾ç¤ºå¯¹åº”é¢æ¿
        stepPanels.forEach((panel, idx) => {
            panel.classList.toggle('active', idx + 1 === step);
        });

        // æ›´æ–°æŒ‰é’®ï¼ˆè¿”å›åªåœ¨å‘å¸ƒé¡µæ˜¾ç¤ºï¼Œå‘å¸ƒåªåœ¨ç¼–è¾‘é¡µæ˜¾ç¤ºï¼‰
        prevBtn.style.display = step === 3 ? 'inline-block' : 'none';
        nextBtn.style.display = step === 2 ? 'inline-block' : 'none';

        // ä¿å­˜ä¼šè¯ï¼ˆåªåœ¨æœ‰ pptSessionId æ—¶ä¿å­˜ï¼‰
        if (wizardState.pptSessionId) {
            saveWizardSession();
        }
    }

    // ä¿å­˜å‘å¯¼ä¼šè¯
    async function saveWizardSession() {
        console.log('[saveWizardSession] è°ƒç”¨, pptSessionId:', wizardState.pptSessionId);
        if (!wizardState.pptSessionId) {
            console.log('[saveWizardSession] æ²¡æœ‰ pptSessionIdï¼Œè·³è¿‡ä¿å­˜');
            return;
        }

        // ç¡®ä¿ wizardSessionId å·²è®¾ç½®
        if (!wizardState.wizardSessionId) {
            wizardState.wizardSessionId = 'wizard-' + wizardState.pptSessionId;
        }

        // è·å–æœ€æ–°çš„æ¨¡æ¿åç§°
        const currentTemplateName = document.getElementById('templateName')?.value?.trim() || wizardState.templateName || 'æœªå‘½åæ¨¡æ¿';
        wizardState.templateName = currentTemplateName;

        const payload = {
            session_id: wizardState.wizardSessionId,
            editor_type: 'wizard',
            template_name: currentTemplateName,
            progress_data: {
                current_step: wizardState.currentStep,
                ppt_session_id: wizardState.pptSessionId,
                template_name: currentTemplateName,
                // ä¸ä¿å­˜ config_dataï¼Œå‘å¸ƒæ—¶ä» PPT ç¼–è¾‘å™¨å®æ—¶è·å–
                published: false
            }
        };
        console.log('[saveWizardSession] ä¿å­˜æ•°æ®:', payload);

        try {
            const response = await fetch("{% url 'save_edit_session' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            console.log('[saveWizardSession] ä¿å­˜ç»“æœ:', result);
        } catch (e) {
            console.error('[saveWizardSession] ä¿å­˜ä¼šè¯å¤±è´¥:', e);
        }
    }

    // ä¸Šä¼  PPT
    async function uploadPPT(file) {
        uploadZone.innerHTML = `
        <div class="upload-icon">â³</div>
        <div class="upload-title">æ­£åœ¨è§£æ PPT...</div>
        <div class="upload-hint">${file.name}</div>
    `;

        const formData = new FormData();
        formData.append('ppt_file', file);

        try {
            const response = await fetch("{% url 'parse_ppt_template' %}", {
                method: 'POST',
                headers: { 'X-CSRFToken': getCSRFToken() },
                body: formData
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error);

            wizardState.pptSessionId = data.template_id;
            wizardState.templateName = data.template_name;

            // åŠ è½½ PPT ç¼–è¾‘å™¨ iframeï¼ˆä¸éœ€è¦é¢„åˆ›å»º sessionï¼Œç›´æ¥ä¼ é€’ template_idï¼‰
            loadPPTEditor(data.template_id);

            // è¿›å…¥ç¬¬äºŒæ­¥
            goToStep(2);

        } catch (e) {
            uploadZone.innerHTML = `
            <div class="upload-icon">âŒ</div>
            <div class="upload-title">ä¸Šä¼ å¤±è´¥</div>
            <div class="upload-hint">${e.message}</div>
        `;
        }
    }

    // åŠ è½½ PPT ç¼–è¾‘å™¨ï¼ˆå‘å¯¼æ¨¡å¼ï¼ŒåŒ…å«å®Œæ•´é…ç½®åŠŸèƒ½ï¼‰
    function loadPPTEditor(sessionId) {
        const container = document.getElementById('pptEditorContainer');
        // æ·»åŠ  wizard=1 å‚æ•°å¯ç”¨å‘å¯¼æ¨¡å¼ï¼ˆæ˜¾ç¤º hint/max_chars/required/note ç¼–è¾‘åŠŸèƒ½ï¼‰
        container.innerHTML = `<iframe id="pptEditorIframe" src="{% url 'template_editor_page' %}?session=${sessionId}&embedded=1&wizard=1"></iframe>`;

        // æ˜¾ç¤ºå·¥å…·æ 
        const toolbar = document.getElementById('step2Toolbar');
        if (toolbar) {
            toolbar.style.display = 'flex';
        }

        // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ä¸”æœ‰é…ç½®æ•°æ®ï¼Œç­‰å¾… iframe åŠ è½½åå‘é€é…ç½®
        if (wizardState.isEditMode && wizardState.configData) {
            const iframe = document.getElementById('pptEditorIframe');
            iframe.onload = () => {
                console.log('[loadPPTEditor] iframe å·²åŠ è½½ï¼Œå‘é€åˆå§‹é…ç½®');
                // å»¶è¿Ÿä¸€ç‚¹ç¡®ä¿ç¼–è¾‘å™¨å®Œå…¨åˆå§‹åŒ–
                setTimeout(() => {
                    iframe.contentWindow.postMessage({
                        type: 'applyInitialConfig',
                        config: wizardState.configData
                    }, '*');
                }, 1000);
            };
        }
    }

    // AI å‘½ååŠŸèƒ½ï¼ˆé€šè¿‡ postMessage ä¸ iframe é€šä¿¡ï¼‰
    let wizardAiNaming = false;
    let currentAiMode = null; // 'override' æˆ– 'fill'

    function triggerAiNaming(forceOverride) {
        if (wizardAiNaming) {
            alert('AI æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...');
            return;
        }

        const iframe = document.getElementById('pptEditorIframe');
        if (!iframe || !iframe.contentWindow) {
            alert('ç¼–è¾‘å™¨å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨å€™...');
            return;
        }

        // å‘é€æ¶ˆæ¯ç»™ iframe è§¦å‘ AI å‘½å
        iframe.contentWindow.postMessage({
            type: 'triggerAiAutoNameAll',
            forceOverride: forceOverride
        }, '*');

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        wizardAiNaming = true;
        currentAiMode = forceOverride ? 'override' : 'fill';

        const overrideBtn = document.getElementById('wizardAiAutoNameAllBtn');
        const fillBtn = document.getElementById('wizardAiAutoFillBtn');

        if (overrideBtn) {
            overrideBtn.disabled = true;
            if (forceOverride) overrideBtn.textContent = 'ğŸ¤– å¤„ç†ä¸­...';
        }
        if (fillBtn) {
            fillBtn.disabled = true;
            if (!forceOverride) fillBtn.textContent = 'âœ¨ å¤„ç†ä¸­...';
        }
        document.getElementById('wizardAiProgress').style.display = 'inline';
    }

    // AI ä¸€é”®å‘½åï¼ˆå¼ºåˆ¶è¦†ç›–æ¨¡å¼ï¼‰
    document.getElementById('wizardAiAutoNameAllBtn')?.addEventListener('click', () => triggerAiNaming(true));

    // AI æŸ¥æ¼è¡¥ç¼ºï¼ˆä¿ç•™ç°æœ‰é…ç½®ï¼‰
    document.getElementById('wizardAiAutoFillBtn')?.addEventListener('click', () => triggerAiNaming(false));

    // ç›‘å¬æ¥è‡ª iframe çš„æ¶ˆæ¯
    window.addEventListener('message', function (event) {
        // AI å‘½åè¿›åº¦æ›´æ–°
        if (event.data.type === 'aiNamingProgress') {
            const progressSpan = document.getElementById('wizardAiProgress');
            if (progressSpan) {
                progressSpan.textContent = event.data.message;
            }
        }

        // AI å‘½åå®Œæˆ
        if (event.data.type === 'aiNamingComplete') {
            wizardAiNaming = false;

            const overrideBtn = document.getElementById('wizardAiAutoNameAllBtn');
            const fillBtn = document.getElementById('wizardAiAutoFillBtn');

            if (overrideBtn) {
                overrideBtn.disabled = false;
                overrideBtn.textContent = 'ğŸ¤– AI ä¸€é”®å‘½å';
            }
            if (fillBtn) {
                fillBtn.disabled = false;
                fillBtn.textContent = 'âœ¨ AI æŸ¥æ¼è¡¥ç¼º';
            }

            document.getElementById('wizardAiProgress').style.display = 'none';
            currentAiMode = null;
        }
    });

    // åŠ è½½é…ç½®ç¼–è¾‘å™¨ï¼ˆä½¿ç”¨ iframe åµŒå…¥ç°æœ‰çš„é…ç½®ç¼–è¾‘å™¨ï¼‰
    async function loadConfigEditor() {
        const container = document.getElementById('configEditorContainer');
        container.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;">
            <div class="text-center">
                <div style="font-size:3rem;margin-bottom:20px;">â³</div>
                <div>æ­£åœ¨ç”Ÿæˆé…ç½®æ¨¡æ¿...</div>
            </div>
        </div>
    `;

        try {
            // è°ƒç”¨ç”Ÿæˆé…ç½® API
            const response = await fetch("{% url 'generate_template_config' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    template_id: wizardState.pptSessionId
                })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error);

            wizardState.configData = data.config;

            // ä½¿ç”¨ iframe åµŒå…¥é…ç½®ç¼–è¾‘å™¨
            container.innerHTML = `<iframe id="configEditorIframe" src="{% url 'config_editor_page' %}?embedded=1" style="width:100%;height:100%;border:none;"></iframe>`;

            // ç­‰å¾… iframe åŠ è½½å®Œæˆåå‘é€é…ç½®æ•°æ®
            const iframe = document.getElementById('configEditorIframe');
            iframe.onload = function () {
                // ç»™ iframe ä¸€ç‚¹æ—¶é—´åˆå§‹åŒ–
                setTimeout(() => {
                    iframe.contentWindow.postMessage({
                        type: 'loadConfig',
                        config: data.config,
                        sessionId: wizardState.wizardSessionId
                    }, '*');
                }, 500);
            };

        } catch (e) {
            container.innerHTML = `
            <div style="display:flex;align-items:center;justify-content:center;height:100%;color:#ef4444;">
                <div class="text-center">
                    <div style="font-size:3rem;margin-bottom:20px;">âŒ</div>
                    <div>ç”Ÿæˆå¤±è´¥: ${e.message}</div>
                    <button class="btn btn-primary" style="margin-top:15px;" onclick="loadConfigEditor()">é‡è¯•</button>
                </div>
            </div>
        `;
        }
    }

    // ä»é…ç½®ç¼–è¾‘å™¨è·å–æœ€æ–°é…ç½®ï¼ˆç”¨äºå‘å¸ƒå‰ï¼‰- æ—§ç‰ˆï¼Œä¿ç•™å…¼å®¹
    function getConfigFromEditor() {
        return new Promise((resolve) => {
            const iframe = document.getElementById('configEditorIframe');
            if (!iframe) {
                resolve(wizardState.configData);
                return;
            }

            // ç›‘å¬æ¥è‡ª iframe çš„å“åº”
            const handler = function (event) {
                if (event.data && event.data.type === 'configData') {
                    window.removeEventListener('message', handler);
                    resolve(event.data.config);
                }
            };
            window.addEventListener('message', handler);

            // è¯·æ±‚é…ç½®æ•°æ®
            iframe.contentWindow.postMessage({ type: 'getConfig' }, '*');

            // è¶…æ—¶åè¿”å›ç¼“å­˜çš„é…ç½®
            setTimeout(() => {
                window.removeEventListener('message', handler);
                resolve(wizardState.configData);
            }, 1000);
        });
    }

    // ä» PPT ç¼–è¾‘å™¨è·å–å®Œæ•´é…ç½®æ•°æ®ï¼ˆæ–°ç‰ˆå‘å¯¼æ¨¡å¼ï¼‰
    function getFullConfigFromPPTEditor() {
        return new Promise((resolve) => {
            const iframe = document.getElementById('pptEditorIframe');
            if (!iframe || !iframe.contentWindow) {
                console.log('[getFullConfigFromPPTEditor] iframe ä¸å­˜åœ¨');
                resolve(null);
                return;
            }

            // ç›‘å¬æ¥è‡ª iframe çš„å“åº”
            const handler = function (event) {
                if (event.data && event.data.type === 'fullConfigData') {
                    window.removeEventListener('message', handler);
                    console.log('[getFullConfigFromPPTEditor] æ”¶åˆ°é…ç½®æ•°æ®:', event.data);
                    resolve(event.data.config);
                }
            };
            window.addEventListener('message', handler);

            // è¯·æ±‚å®Œæ•´é…ç½®æ•°æ®
            iframe.contentWindow.postMessage({ type: 'getFullConfig' }, '*');

            // è¶…æ—¶åè¿”å› null
            setTimeout(() => {
                window.removeEventListener('message', handler);
                console.log('[getFullConfigFromPPTEditor] è¶…æ—¶ï¼Œæœªæ”¶åˆ°å“åº”');
                resolve(null);
            }, 2000);
        });
    }

    // å‘å¸ƒæ¨¡æ¿
    async function publishTemplate() {
        const templateName = document.getElementById('templateName').value.trim();
        const statusDiv = document.getElementById('publishStatus');
        const publishBtn = document.getElementById('publishBtn');

        if (!templateName) {
            statusDiv.innerHTML = '<div class="alert alert-danger">è¯·è¾“å…¥æ¨¡æ¿åç§°</div>';
            statusDiv.style.display = 'block';
            return;
        }

        // éªŒè¯åç§°æ ¼å¼
        if (!/^[\u4e00-\u9fa5a-zA-Z0-9_-]+$/.test(templateName)) {
            statusDiv.innerHTML = '<div class="alert alert-danger">æ¨¡æ¿åç§°åªèƒ½åŒ…å«ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œæ¨ªçº¿</div>';
            statusDiv.style.display = 'block';
            return;
        }

        const isEditMode = wizardState.isEditMode;
        const originalName = wizardState.originalTemplateName;
        const loadingText = isEditMode ? 'ä¿å­˜ä¸­...' : 'å‘å¸ƒä¸­...';
        const buttonText = isEditMode ? '<i class="fas fa-save"></i> ä¿å­˜ä¿®æ”¹' : '<i class="fas fa-rocket"></i> å‘å¸ƒæ¨¡æ¿';
        const successText = isEditMode ? '<i class="fas fa-check"></i> å·²ä¿å­˜' : '<i class="fas fa-check"></i> å·²å‘å¸ƒ';

        publishBtn.disabled = true;
        publishBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è·å–é…ç½®æ•°æ®...';
        statusDiv.style.display = 'none';

        // ä¼˜å…ˆä» PPT ç¼–è¾‘å™¨è·å–å®Œæ•´é…ç½®ï¼ˆæ–°ç‰ˆå‘å¯¼æ¨¡å¼ï¼ŒåŒ…å« hint/max_chars/required/noteï¼‰
        let fullConfig = await getFullConfigFromPPTEditor();

        // å¦‚æœ PPT ç¼–è¾‘å™¨æ²¡æœ‰è¿”å›ï¼Œå°è¯•ä»é…ç½®ç¼–è¾‘å™¨è·å–ï¼ˆå…¼å®¹æ—§æµç¨‹ï¼‰
        if (!fullConfig) {
            console.log('[publishTemplate] PPT ç¼–è¾‘å™¨æœªè¿”å›é…ç½®ï¼Œå°è¯•ä»é…ç½®ç¼–è¾‘å™¨è·å–');
            const latestConfig = await getConfigFromEditor();
            if (latestConfig) {
                wizardState.configData = latestConfig;
            }
        } else {
            wizardState.configData = fullConfig;
        }

        if (!wizardState.configData) {
            statusDiv.innerHTML = '<div class="alert alert-danger">é…ç½®æ•°æ®ä¸å­˜åœ¨ï¼Œè¯·ç¡®ä¿å·²å®Œæˆæ¨¡æ¿ç¼–è¾‘</div>';
            statusDiv.style.display = 'block';
            publishBtn.disabled = false;
            publishBtn.innerHTML = buttonText;
            return;
        }

        publishBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${loadingText}`;

        try {
            const response = await fetch("{% url 'publish_template' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    template_name: templateName,
                    ppt_session_id: wizardState.pptSessionId,
                    config_data: wizardState.configData,
                    is_edit_mode: isEditMode,
                    original_template_name: originalName
                })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error);

            const successMessage = isEditMode ? 'ä¿å­˜æˆåŠŸï¼' : 'å‘å¸ƒæˆåŠŸï¼';
            statusDiv.innerHTML = `
            <div class="alert alert-success">
                <strong>ğŸ‰ ${successMessage}</strong><br>
                æ¨¡æ¿å·²ä¿å­˜åˆ°: ${data.template_path}
            </div>
        `;
            statusDiv.style.display = 'block';
            publishBtn.innerHTML = successText;
            publishBtn.classList.remove('btn-primary');
            publishBtn.classList.add('btn-success');

        } catch (e) {
            statusDiv.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
            statusDiv.style.display = 'block';
            publishBtn.disabled = false;
            publishBtn.innerHTML = buttonText;
        }
    }

    // äº‹ä»¶ç»‘å®š
    document.addEventListener('DOMContentLoaded', function () {
        // åˆå§‹åŒ– DOM å…ƒç´ 
        stepPanels = document.querySelectorAll('.step-panel');
        prevBtn = document.getElementById('prevBtn');
        nextBtn = document.getElementById('nextBtn');
        uploadZone = document.getElementById('uploadZone');
        pptFileInput = document.getElementById('pptFileInput');

        // ä¸Šä¼ åŒºåŸŸç‚¹å‡»
        uploadZone.addEventListener('click', () => pptFileInput.click());

        // æ–‡ä»¶é€‰æ‹©
        pptFileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) uploadPPT(e.target.files[0]);
        });

        // æ‹–æ‹½ä¸Šä¼ 
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files[0]) uploadPPT(e.dataTransfer.files[0]);
        });

        // ä¸Šä¸€æ­¥/ä¸‹ä¸€æ­¥æŒ‰é’®
        prevBtn.addEventListener('click', () => {
            // æœ€å°åªèƒ½å›åˆ°æ­¥éª¤ 2ï¼ˆå…ƒç´ å‘½åï¼‰ï¼Œä¸èƒ½å›åˆ°ä¸Šä¼ æ­¥éª¤
            if (wizardState.currentStep > 2) {
                goToStep(wizardState.currentStep - 1);
            }
        });

        nextBtn.addEventListener('click', () => {
            if (wizardState.currentStep === 2) {
                // ä»ç¼–è¾‘æ¨¡æ¿ç›´æ¥è¿›å…¥å‘å¸ƒï¼ˆé…ç½®å·²åœ¨ç¼–è¾‘å™¨ä¸­å®Œæˆï¼‰
                goToStep(3);
            }
        });

        // å‘å¸ƒæŒ‰é’®
        document.getElementById('publishBtn').addEventListener('click', publishTemplate);

        // æ£€æŸ¥æ˜¯å¦æ˜¯ç¼–è¾‘å·²å‘å¸ƒæ¨¡æ¿æ¨¡å¼
        if (wizardState.editModeData) {
            console.log('Edit mode detected:', wizardState.editModeData);
            initEditMode();
            return;  // è·³è¿‡æ™®é€šä¼šè¯æ¢å¤
        }

        // å¦‚æœé€šè¿‡ URL å‚æ•°ä¼ å…¥ sessionï¼Œè‡ªåŠ¨æ¢å¤
        const urlParams = new URLSearchParams(window.location.search);
        const sessionParam = urlParams.get('session');
        console.log('Session param:', sessionParam);
        console.log('Existing session:', wizardState.existingSession);
        if (sessionParam && wizardState.existingSession) {
            console.log('Restoring wizard session...');
            restoreWizardSession();
        }
    });

    // åˆå§‹åŒ–ç¼–è¾‘æ¨¡å¼ï¼ˆç¼–è¾‘å·²å‘å¸ƒçš„æ¨¡æ¿ï¼‰
    function initEditMode() {
        const data = wizardState.editModeData;
        wizardState.isEditMode = true;
        wizardState.originalTemplateName = data.template_name;
        wizardState.pptSessionId = data.ppt_session_id;
        wizardState.templateName = data.template_name;
        wizardState.configData = data.config_data;
        wizardState.wizardSessionId = 'edit-' + data.ppt_session_id;

        // å¡«å……æ¨¡æ¿åç§°
        document.getElementById('templateName').value = data.template_name;

        // æ›´æ–°å‘å¸ƒæŒ‰é’®æ–‡æ¡ˆä¸º"ä¿å­˜"
        const publishBtn = document.getElementById('publishBtn');
        publishBtn.innerHTML = '<i class="fas fa-save"></i> ä¿å­˜ä¿®æ”¹';

        // æ›´æ–°æ ‡é¢˜æç¤º
        const publishTitle = document.querySelector('#step-3 h3');
        if (publishTitle) {
            publishTitle.textContent = 'ä¿å­˜æ¨¡æ¿ä¿®æ”¹';
        }

        // åŠ è½½ PPT ç¼–è¾‘å™¨
        loadPPTEditor(data.ppt_session_id);

        // è·³è½¬åˆ°ç¼–è¾‘æ­¥éª¤
        goToStep(2);
    }

    // æ¢å¤å‘å¯¼ä¼šè¯
    function restoreWizardSession() {
        const session = wizardState.existingSession;
        console.log('restoreWizardSession called, session:', session);
        if (!session) return;

        const progressData = session.progress_data || {};
        console.log('Progress data:', progressData);

        wizardState.wizardSessionId = session.session_id;
        wizardState.pptSessionId = progressData.ppt_session_id;
        wizardState.templateName = progressData.template_name || session.template_name;
        // ä¸æ¢å¤æ—§çš„ configDataï¼Œå‘å¸ƒæ—¶ä» PPT ç¼–è¾‘å™¨å®æ—¶è·å–æœ€æ–°é…ç½®
        wizardState.configData = null;

        console.log('Restored state:', {
            wizardSessionId: wizardState.wizardSessionId,
            pptSessionId: wizardState.pptSessionId,
            templateName: wizardState.templateName,
            targetStep: progressData.current_step
        });

        // å¡«å……æ¨¡æ¿åç§°è¾“å…¥æ¡†
        if (wizardState.templateName) {
            document.getElementById('templateName').value = wizardState.templateName;
        }

        // åŠ è½½ PPT ç¼–è¾‘å™¨ï¼ˆå¦‚æœæœ‰ ppt_session_idï¼‰
        if (progressData.ppt_session_id) {
            console.log('Loading PPT editor with session:', progressData.ppt_session_id);
            loadPPTEditor(progressData.ppt_session_id);
        }

        // è·³è½¬åˆ°ä¸Šæ¬¡çš„æ­¥éª¤ï¼ˆæ–°ç‰ˆåªæœ‰3æ­¥ï¼šä¸Šä¼ ã€ç¼–è¾‘ã€å‘å¸ƒï¼‰
        // å¦‚æœæ—§ä¼šè¯ä¿å­˜çš„æ˜¯ step 4ï¼Œæ˜ å°„åˆ°æ–°çš„ step 3
        let targetStep = progressData.current_step || 2;
        if (targetStep > 3) targetStep = 3;
        console.log('Going to step:', targetStep);

        // è·³è½¬åˆ°ä¸Šæ¬¡çš„æ­¥éª¤
        goToStep(targetStep);
    }
</script>
{% endblock %}