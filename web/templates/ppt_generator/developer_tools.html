{% extends 'base.html' %}

{% block title %}å¼€å‘è€…å·¥å…· - S2S{% endblock %}

{% block extra_css %}
<style>
    .tabs {
        display: flex;
        border-bottom: 2px solid var(--border-color);
        margin-bottom: var(--spacing-lg);
    }

    .tab {
        padding: var(--spacing-md) var(--spacing-lg);
        cursor: pointer;
        border: none;
        background: none;
        font-size: 1rem;
        color: var(--text-secondary);
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
    }

    .tab:hover {
        color: var(--primary-color);
    }

    .tab.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
        font-weight: 600;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* Editor layout */
    .editor-container {
        display: flex;
        gap: var(--spacing-lg);
        height: calc(100vh - 300px);
        min-height: 600px;
    }

    .page-list {
        width: 280px;
        flex-shrink: 0;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        overflow-y: auto;
        background: var(--bg-secondary);
    }

    .page-item {
        padding: var(--spacing-md);
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .page-item:hover {
        background: var(--bg-hover);
    }

    .page-item.active {
        background: var(--primary-color);
        color: white;
    }

    .page-item-title {
        font-weight: 600;
        margin-bottom: 4px;
    }

    .page-item-meta {
        font-size: 0.85rem;
        opacity: 0.8;
    }

    .edit-area {
        flex: 1;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: var(--spacing-lg);
        overflow-y: auto;
        background: white;
    }

    .field-editor {
        margin-bottom: var(--spacing-lg);
        padding: var(--spacing-md);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        background: var(--bg-secondary);
    }

    .field-name {
        font-weight: 600;
        margin-bottom: var(--spacing-sm);
        color: var(--primary-color);
    }

    .field-row {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-sm);
        align-items: center;
    }

    .field-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .field-input {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        font-size: 0.9rem;
    }

    .field-input:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    .checkbox-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .upload-zone {
        border: 2px dashed var(--border-color);
        border-radius: var(--border-radius);
        padding: var(--spacing-xl);
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .upload-zone:hover {
        border-color: var(--primary-color);
        background: var(--bg-hover);
    }

    .upload-zone.dragover {
        border-color: var(--primary-color);
        background: var(--primary-light);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h2>ğŸ”§ å¼€å‘è€…å·¥å…·</h2>
    <p class="subtitle">å¤§æ¨¡å‹é…ç½®æ¨¡æ¿çš„ç”Ÿæˆä¸ç¼–è¾‘ï¼ˆå¼€å‘è€…åŠŸèƒ½ï¼‰</p>
</div>

<!-- Tabs -->
<div class="tabs">
    <button class="tab active" data-tab="generate">ç”Ÿæˆé…ç½®æ¨¡æ¿</button>
    <button class="tab" data-tab="edit">ç¼–è¾‘é…ç½®æ¨¡æ¿</button>
</div>

<!-- Tab 1: Generate -->
<div id="generateTab" class="tab-content active">
    <div class="card">
        <div class="card-header">
            <h3>ğŸ“¤ ä¸Šä¼  PPT æ¨¡æ¿æ–‡ä»¶</h3>
        </div>
        <div class="card-body">
            <form id="generateForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-group">
                    <label for="template_file" class="form-label required">
                        PPTæ¨¡æ¿æ–‡ä»¶
                    </label>
                    <div class="file-upload-wrapper">
                        <input type="file" id="template_file" name="template_file" accept=".pptx" required>
                        <span class="file-upload-label">é€‰æ‹©æ¨¡æ¿æ–‡ä»¶ (.pptx)</span>
                    </div>
                    <small class="form-help">ä¸Šä¼ PPTæ¨¡æ¿æ–‡ä»¶ä»¥ç”ŸæˆJSONæè¿°</small>
                </div>

                <div class="form-group">
                    <label for="mode" class="form-label">å¯¼å‡ºæ¨¡å¼</label>
                    <select id="mode" name="mode" class="text-input">
                        <option value="semantic">è¯­ä¹‰æ¨¡å¼ - ä»…å¯¼å‡ºå‘½åè§„èŒƒçš„å…ƒç´ ï¼ˆæ¨èï¼‰</option>
                        <option value="text">æ–‡æœ¬æ¨¡å¼ - å¯¼å‡ºæ‰€æœ‰å¯ç¼–è¾‘æ–‡æœ¬æ¡†</option>
                    </select>
                    <small class="form-help">è¯­ä¹‰æ¨¡å¼åªå¯¼å‡ºåŒ…å«"xxåŒº"ç­‰å‘½åçš„å…ƒç´ ï¼Œæ–‡æœ¬æ¨¡å¼å¯¼å‡ºæ‰€æœ‰æ–‡æœ¬æ¡†</small>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-large">
                        ğŸš€ ç”Ÿæˆé…ç½®æ¨¡æ¿
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="generateResult" class="card" style="display: none; margin-top: var(--spacing-lg);">
        <div class="card-header">
            <h3>âœ… ç”ŸæˆæˆåŠŸ</h3>
        </div>
        <div class="card-body">
            <p>é…ç½®æ¨¡æ¿å·²ç”Ÿæˆï¼ŒåŒ…å« <strong id="pageCount"></strong> ä¸ªé¡µé¢ã€‚</p>
            <div class="form-actions">
                <button id="downloadGeneratedBtn" class="btn btn-success">
                    ğŸ“¥ ä¸‹è½½ JSON æ–‡ä»¶
                </button>
                <button id="editGeneratedBtn" class="btn btn-primary">
                    âœï¸ ç¼–è¾‘é…ç½®æ¨¡æ¿
                </button>
            </div>
        </div>
    </div>

    <div id="generateError" class="card" style="display: none; margin-top: var(--spacing-lg);">
        <div class="card-header">
            <h3>âŒ ç”Ÿæˆå¤±è´¥</h3>
        </div>
        <div class="card-body">
            <div id="generateErrorContent" class="error-details"></div>
        </div>
    </div>
</div>

<!-- Tab 2: Edit -->
<div id="editTab" class="tab-content">
    <div id="uploadSection">
        <div class="card">
            <div class="card-header">
                <h3>ğŸ“‚ ä¸Šä¼ é…ç½®æ¨¡æ¿ JSON</h3>
            </div>
            <div class="card-body">
                <div class="upload-zone" id="uploadZone">
                    <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">ğŸ“„</div>
                    <p style="font-size: 1.1rem; margin-bottom: var(--spacing-sm);">
                        ç‚¹å‡»æˆ–æ‹–æ‹½ JSON æ–‡ä»¶åˆ°æ­¤å¤„
                    </p>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        æ”¯æŒ .json æ ¼å¼çš„é…ç½®æ¨¡æ¿æ–‡ä»¶
                    </p>
                    <input type="file" id="jsonFile" accept=".json" style="display: none;">
                </div>
            </div>
        </div>
    </div>

    <div id="editorSection" style="display: none;">
        <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3>âœï¸ ç¼–è¾‘é…ç½®æ¨¡æ¿</h3>
                <div style="display: flex; gap: var(--spacing-sm);">
                    <button id="aiEnrichBtn" class="btn btn-primary btn-small">
                        ğŸ¤– AI ä¸€é”®å¡«å……
                    </button>
                    <button id="uploadAnotherBtn" class="btn btn-secondary btn-small">
                        ğŸ“‚ ä¸Šä¼ å…¶ä»–æ–‡ä»¶
                    </button>
                </div>
            </div>
            <div class="card-body" style="padding: 0;">
                <div class="editor-container">
                    <div class="page-list" id="pageList">
                        <!-- Pages will be populated here -->
                    </div>
                    <div class="edit-area" id="editArea">
                        <p style="color: var(--text-secondary); text-align: center; padding: var(--spacing-xl);">
                            è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªé¡µé¢å¼€å§‹ç¼–è¾‘
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-actions" style="margin-top: var(--spacing-lg);">
            <button id="downloadEditedBtn" class="btn btn-success btn-large">
                ğŸ“¥ ä¸‹è½½ç¼–è¾‘åçš„é…ç½®æ¨¡æ¿
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Global state
    let templateData = null;
    let currentPageIndex = 0;

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function () {
            const tabName = this.dataset.tab;

            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');
        });
    });

    // Generate Tab: Form submission
    document.getElementById('generateForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const resultDiv = document.getElementById('generateResult');
        const errorDiv = document.getElementById('generateError');

        resultDiv.style.display = 'none';
        errorDiv.style.display = 'none';

        try {
            const response = await fetch('{% url "generate_config_template" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            const data = await response.json();

            if (response.ok) {
                templateData = data;
                document.getElementById('pageCount').textContent = data.ppt_pages.length;
                resultDiv.style.display = 'block';
            } else {
                let errorMsg = data.error || 'ç”Ÿæˆå¤±è´¥';
                if (data.traceback) {
                    errorMsg += '\n\nè¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š\n' + data.traceback;
                }
                document.getElementById('generateErrorContent').innerHTML = `<pre>${errorMsg}</pre>`;
                errorDiv.style.display = 'block';
            }
        } catch (error) {
            document.getElementById('generateErrorContent').innerHTML = `<pre>${error.message}</pre>`;
            errorDiv.style.display = 'block';
        }
    });

    // Download generated JSON
    document.getElementById('downloadGeneratedBtn').addEventListener('click', function () {
        downloadJSON(templateData, 'template.json');
    });

    // Edit generated JSON
    document.getElementById('editGeneratedBtn').addEventListener('click', function () {
        // Switch to edit tab
        document.querySelector('.tab[data-tab="edit"]').click();
        // Load the generated data
        loadTemplateData(templateData);
    });

    // Edit Tab: Upload zone
    const uploadZone = document.getElementById('uploadZone');
    const jsonFileInput = document.getElementById('jsonFile');

    uploadZone.addEventListener('click', () => jsonFileInput.click());

    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file && file.name.endsWith('.json')) {
            loadJSONFile(file);
        } else {
            alert('è¯·ä¸Šä¼  .json æ ¼å¼çš„æ–‡ä»¶');
        }
    });

    jsonFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            loadJSONFile(file);
        }
    });

    // Upload another file
    document.getElementById('uploadAnotherBtn').addEventListener('click', function () {
        document.getElementById('uploadSection').style.display = 'block';
        document.getElementById('editorSection').style.display = 'none';
        templateData = null;
        currentPageIndex = 0;
    });

    // AI enrich button
    document.getElementById('aiEnrichBtn').addEventListener('click', async function () {
        if (!templateData) {
            alert('è¯·å…ˆä¸Šä¼ é…ç½®æ¨¡æ¿æ–‡ä»¶');
            return;
        }

        // Show warning dialog
        const confirmed = confirm(
            'âš ï¸ è­¦å‘Šï¼šAI ç”Ÿæˆçš„å†…å®¹å¯èƒ½ä¸å‡†ç¡®ï¼Œéœ€è¦äººå·¥å®¡æ ¸å’Œä¿®æ”¹ã€‚\n\n' +
            'æ­¤æ“ä½œå°†ä½¿ç”¨å¤§æ¨¡å‹è‡ªåŠ¨å¡«å……æ‰€æœ‰é¡µé¢çš„ hintã€requiredã€max_chars å’Œ notes å­—æ®µã€‚\n\n' +
            'æ˜¯å¦ç»§ç»­ï¼Ÿ'
        );

        if (!confirmed) {
            return;
        }

        // Disable button and show loading
        const btn = this;
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'ğŸ¤– AI å¡«å……ä¸­...';

        try {
            const response = await fetch('{% url "ai_enrich_template" %}', {
                method: 'POST',
                body: JSON.stringify(templateData),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            if (response.ok) {
                const enrichedData = await response.json();
                templateData = enrichedData;

                // Re-render page list and current page
                renderPageList();
                renderEditArea();

                alert('âœ… AI å¡«å……å®Œæˆï¼è¯·ä»”ç»†æ£€æŸ¥å¹¶ä¿®æ”¹ç”Ÿæˆçš„å†…å®¹ã€‚');
            } else {
                const error = await response.json();
                alert('âŒ AI å¡«å……å¤±è´¥ï¼š' + (error.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            alert('âŒ AI å¡«å……å¤±è´¥ï¼š' + error.message);
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    });

    // Load JSON file
    function loadJSONFile(file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            try {
                const data = JSON.parse(e.target.result);
                loadTemplateData(data);
            } catch (error) {
                alert('JSON æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼š' + error.message);
            }
        };
        reader.readAsText(file);
    }

    // Load template data into editor
    function loadTemplateData(data) {
        templateData = data;
        document.getElementById('uploadSection').style.display = 'none';
        document.getElementById('editorSection').style.display = 'block';

        renderPageList();
        if (data.ppt_pages && data.ppt_pages.length > 0) {
            selectPage(0);
        }
    }

    // Render page list
    function renderPageList() {
        const pageList = document.getElementById('pageList');
        pageList.innerHTML = '';

        templateData.ppt_pages.forEach((page, index) => {
            const pageItem = document.createElement('div');
            pageItem.className = 'page-item';
            if (index === currentPageIndex) {
                pageItem.classList.add('active');
            }

            const fieldCount = Object.keys(page.content || {}).length;

            pageItem.innerHTML = `
            <div class="page-item-title">${page.page_type}</div>
            <div class="page-item-meta">
                é¡µç : ${page.template_page_num} | å­—æ®µ: ${fieldCount}
            </div>
        `;

            pageItem.addEventListener('click', () => selectPage(index));
            pageList.appendChild(pageItem);
        });
    }

    // Select a page
    function selectPage(index) {
        currentPageIndex = index;

        // Update page list highlighting
        document.querySelectorAll('.page-item').forEach((item, i) => {
            if (i === index) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });

        // Render edit area
        renderEditArea();
    }

    // Render edit area for current page
    function renderEditArea() {
        const page = templateData.ppt_pages[currentPageIndex];
        const editArea = document.getElementById('editArea');

        let html = `
        <h3 style="margin-bottom: var(--spacing-lg);">
            ${page.page_type} <span style="color: var(--text-secondary); font-size: 0.9rem;">(é¡µç : ${page.template_page_num})</span>
        </h3>

        <!-- Page Notes -->
        <div class="field-editor" style="background: var(--primary-light); border-color: var(--primary-color);">
            <div class="field-name" style="color: var(--primary-color);">ğŸ“ é¡µé¢è¯´æ˜ (notes)</div>
            <textarea
                class="field-input"
                style="width: 100%; min-height: 80px; resize: vertical;"
                data-type="notes"
                placeholder="å¸®åŠ©å¤§æ¨¡å‹ç†è§£è¿™ä¸€é¡µçš„å…·ä½“ç”¨å¤„..."
            >${page.meta?.notes || ''}</textarea>
            <small style="display: block; margin-top: 8px; color: var(--text-secondary);">
                è¿™æ®µè¯´æ˜ä¼šå¸®åŠ©å¤§æ¨¡å‹ç†è§£è¯¥é¡µé¢çš„ç”¨é€”å’Œå†…å®¹è¦æ±‚
            </small>
        </div>

        <h4 style="margin: var(--spacing-lg) 0 var(--spacing-md) 0;">å­—æ®µé…ç½®</h4>
    `;

        // Render fields
        const content = page.content || {};
        Object.keys(content).forEach(fieldName => {
            const field = content[fieldName];

            html += `
            <div class="field-editor">
                <div class="field-name">${fieldName}</div>

                <div class="field-row">
                    <div class="field-label">æç¤º (hint):</div>
                    <input
                        type="text"
                        class="field-input"
                        value="${field.hint || ''}"
                        data-field="${fieldName}"
                        data-prop="hint"
                        placeholder="å¸®åŠ©å¤§æ¨¡å‹ç†è§£éœ€è¦å¡«ä»€ä¹ˆ..."
                    >
                </div>

                <div class="field-row">
                    <div class="field-label">æ˜¯å¦å¿…å¡«:</div>
                    <div class="checkbox-wrapper">
                        <input
                            type="checkbox"
                            ${field.required ? 'checked' : ''}
                            data-field="${fieldName}"
                            data-prop="required"
                        >
                        <span style="font-size: 0.9rem;">å¿…å¡«å­—æ®µ</span>
                    </div>
                </div>

                <div class="field-row">
                    <div class="field-label">æœ€å¤§å­—æ•°:</div>
                    <input
                        type="number"
                        class="field-input"
                        value="${field.max_chars || ''}"
                        data-field="${fieldName}"
                        data-prop="max_chars"
                        placeholder="æœ€å¤§å­—ç¬¦æ•°..."
                        min="1"
                    >
                </div>
            </div>
        `;
        });

        editArea.innerHTML = html;

        // Add event listeners for all inputs
        editArea.querySelectorAll('input, textarea').forEach(input => {
            input.addEventListener('change', handleFieldChange);
        });
    }

    // Handle field changes
    function handleFieldChange(e) {
        const input = e.target;
        const fieldName = input.dataset.field;
        const prop = input.dataset.prop;
        const type = input.dataset.type;

        if (type === 'notes') {
            // Update page notes
            if (!templateData.ppt_pages[currentPageIndex].meta) {
                templateData.ppt_pages[currentPageIndex].meta = {};
            }
            templateData.ppt_pages[currentPageIndex].meta.notes = input.value;
        } else if (fieldName && prop) {
            // Update field property
            const page = templateData.ppt_pages[currentPageIndex];
            if (!page.content[fieldName]) {
                page.content[fieldName] = {};
            }

            if (input.type === 'checkbox') {
                page.content[fieldName][prop] = input.checked;
            } else if (input.type === 'number') {
                page.content[fieldName][prop] = parseInt(input.value) || 0;
            } else {
                page.content[fieldName][prop] = input.value;
            }
        }
    }

    // Download edited JSON
    document.getElementById('downloadEditedBtn').addEventListener('click', function () {
        downloadJSON(templateData, 'template_edited.json');
    });

    // Utility: Download JSON
    function downloadJSON(data, filename) {
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    }
</script>
{% endblock %}