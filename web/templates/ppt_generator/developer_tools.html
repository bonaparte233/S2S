{% extends 'base.html' %}
{% load static %}

{% block title %}å¼€å‘è€…å·¥å…· - S2S{% endblock %}

{% block extra_css %}
<style>
    /* å·¥å…·å¡ç‰‡ç½‘æ ¼å¸ƒå±€ */
    .tools-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
    }

    .tool-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    .tool-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .tool-card-header {
        padding: var(--spacing-lg);
        position: relative;
        overflow: hidden;
    }

    .tool-card-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        opacity: 0.1;
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }

    .tool-card-icon {
        font-size: 2.5rem;
        margin-bottom: var(--spacing-sm);
        position: relative;
        z-index: 1;
    }

    .tool-card-title {
        font-size: 1.25rem;
        font-weight: 700;
        margin: 0;
        color: white;
        position: relative;
        z-index: 1;
    }

    .tool-card-subtitle {
        font-size: 0.9rem;
        opacity: 0.9;
        margin: var(--spacing-xs) 0 0 0;
        color: white;
        position: relative;
        z-index: 1;
    }

    .tool-card-body {
        padding: var(--spacing-lg);
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .tool-card-description {
        color: var(--text-secondary);
        font-size: 0.95rem;
        line-height: 1.6;
        margin-bottom: var(--spacing-lg);
        flex: 1;
    }

    .tool-card-features {
        list-style: none;
        padding: 0;
        margin: 0 0 var(--spacing-lg) 0;
    }

    .tool-card-features li {
        padding: var(--spacing-xs) 0;
        font-size: 0.85rem;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .tool-card-features li::before {
        content: 'âœ“';
        color: var(--success-color);
        font-weight: bold;
    }

    .tool-card-action {
        display: block;
        width: 100%;
        padding: var(--spacing-md);
        border: none;
        border-radius: var(--border-radius);
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
        text-decoration: none;
    }

    .tool-card-action-primary {
        background: var(--primary-color);
        color: white;
    }

    .tool-card-action-primary:hover {
        background: var(--primary-dark);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
    }

    .tool-card-action-secondary {
        background: var(--bg-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }

    .tool-card-action-secondary:hover {
        background: #dfe6e9;
        border-color: var(--primary-color);
        color: var(--primary-color);
        transform: translateY(-2px);
    }

    /* ä¸åŒå¡ç‰‡çš„æ¸å˜è‰² */
    .tool-card-header.gradient-purple {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .tool-card-header.gradient-blue {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    }

    .tool-card-header.gradient-green {
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    }

    .tool-card-header.gradient-orange {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    }

    .tool-card-header.gradient-pink {
        background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
    }

    .tool-card-header.gradient-teal {
        background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
    }

    /* æ ‡ç­¾ */
    .tool-badge {
        display: inline-block;
        padding: 3px 8px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-radius: 4px;
        margin-left: var(--spacing-sm);
        position: relative;
        z-index: 1;
    }

    .tool-badge-new {
        background: rgba(255, 255, 255, 0.25);
        color: white;
    }

    .tool-badge-beta {
        background: rgba(255, 193, 7, 0.3);
        color: #fff3cd;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h2>ğŸ”§ å¼€å‘è€…å·¥å…·</h2>
    <p class="subtitle">PPT æ¨¡æ¿å¼€å‘ä¸é…ç½®ç®¡ç†å·¥å…·é›†</p>
</div>

<!-- å·²å‘å¸ƒæ¨¡æ¿åˆ—è¡¨ -->
{% if published_templates %}
<div class="published-templates-section" style="margin-bottom: 2rem;">
    <h4 style="margin-bottom: 1rem; color: #333;">
        <i class="fas fa-folder-open" style="color: #667eea;"></i>
        å·²å‘å¸ƒçš„æ¨¡æ¿ ({{ published_templates|length }})
    </h4>
    <div class="templates-list" style="display: flex; flex-wrap: wrap; gap: 12px;">
        {% for tpl in published_templates %}
        <a href="{% url 'template_wizard_page' %}?edit={{ tpl.name }}" class="template-item" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px;
                  background: white; border-radius: 8px; text-decoration: none; color: #333;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: all 0.2s ease;
                  border: 1px solid #e0e0e0;">
            <span style="font-size: 1.2rem;">ğŸ“</span>
            <span style="font-weight: 500;">{{ tpl.name }}</span>
            {% if tpl.has_json %}
            <span
                style="font-size: 0.7rem; background: #e8f5e9; color: #2e7d32; padding: 2px 6px; border-radius: 4px;">å·²é…ç½®</span>
            {% else %}
            <span
                style="font-size: 0.7rem; background: #fff3e0; color: #e65100; padding: 2px 6px; border-radius: 4px;">å¾…é…ç½®</span>
            {% endif %}
            <i class="fas fa-pencil-alt" style="color: #667eea; font-size: 0.85rem;"></i>
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- å·¥å…·å¡ç‰‡ç½‘æ ¼ -->
<div class="tools-grid">
    <!-- æ¨¡æ¿åˆ¶ä½œå‘å¯¼ - æ”¾åœ¨ç¬¬ä¸€ä½ -->
    <div class="tool-card">
        <div class="tool-card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="tool-card-icon">ğŸ§™â€â™‚ï¸</div>
            <h3 class="tool-card-title">
                æ¨¡æ¿åˆ¶ä½œå‘å¯¼
                <span class="tool-badge tool-badge-new">NEW</span>
            </h3>
            <p class="tool-card-subtitle">ä¸€ç«™å¼æ¨¡æ¿åˆ›å»ºæµç¨‹</p>
        </div>
        <div class="tool-card-body">
            <p class="tool-card-description">
                ä»ä¸Šä¼  PPT åˆ°å‘å¸ƒå®Œæ•´æ¨¡æ¿çš„ä¸€ç«™å¼å‘å¯¼æµç¨‹ã€‚æ•´åˆå…ƒç´ å‘½åã€é…ç½®ç”Ÿæˆã€æ¨¡æ¿å‘å¸ƒï¼Œä¸€æ°”å‘µæˆã€‚
            </p>
            <ul class="tool-card-features">
                <li>å››æ­¥å®Œæˆæ¨¡æ¿åˆ¶ä½œ</li>
                <li>è‡ªåŠ¨ä¿å­˜ç¼–è¾‘è¿›åº¦</li>
                <li>ä¸€é”®å‘å¸ƒåˆ°æ¨¡æ¿åº“</li>
                <li>æ”¯æŒéšæ—¶ç»§ç»­ç¼–è¾‘</li>
            </ul>
            <a href="{% url 'template_wizard_page' %}" class="tool-card-action tool-card-action-primary"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                å¼€å§‹åˆ¶ä½œ â†’
            </a>
        </div>
    </div>

    <!-- PPT æ¨¡æ¿ç¼–è¾‘å™¨ -->
    <div class="tool-card">
        <div class="tool-card-header gradient-purple">
            <div class="tool-card-icon">ğŸ¨</div>
            <h3 class="tool-card-title">
                PPT æ¨¡æ¿ç¼–è¾‘å™¨
            </h3>
            <p class="tool-card-subtitle">å¯è§†åŒ–æ¨¡æ¿å…ƒç´ ç¼–è¾‘å·¥å…·</p>
        </div>
        <div class="tool-card-body">
            <p class="tool-card-description">
                ä¸Šä¼  PPT æ¨¡æ¿ï¼Œå¯è§†åŒ–æŸ¥çœ‹å’Œç¼–è¾‘æ¯ä¸ªå…ƒç´ ï¼Œä¸ºå…ƒç´ å‘½åå¹¶è‡ªåŠ¨ç”Ÿæˆé…ç½®æ–‡ä»¶ã€‚æ”¯æŒ AI ä¸€é”®å‘½ååŠŸèƒ½ã€‚
            </p>
            <ul class="tool-card-features">
                <li>å¯è§†åŒ–é¢„è§ˆ PPT é¡µé¢</li>
                <li>äº¤äº’å¼å…ƒç´ å‘½å</li>
                <li>AI æ™ºèƒ½è¯†åˆ«ä¸å‘½å</li>
                <li>ä¸€é”®å¯¼å‡ºé…ç½® JSON</li>
            </ul>
            <a href="{% url 'template_editor_page' %}" class="tool-card-action tool-card-action-secondary">
                æ‰“å¼€ç¼–è¾‘å™¨ â†’
            </a>
        </div>
    </div>

    <!-- é…ç½®æ¨¡æ¿ç”Ÿæˆ -->
    <div class="tool-card">
        <div class="tool-card-header gradient-blue">
            <div class="tool-card-icon">ğŸ“„</div>
            <h3 class="tool-card-title">é…ç½®æ¨¡æ¿ç”Ÿæˆ</h3>
            <p class="tool-card-subtitle">å¿«é€Ÿç”Ÿæˆ JSON é…ç½®</p>
        </div>
        <div class="tool-card-body">
            <p class="tool-card-description">
                ä¸Šä¼  PPT æ¨¡æ¿æ–‡ä»¶ï¼Œè‡ªåŠ¨æå–æ‰€æœ‰å¯ç¼–è¾‘å…ƒç´ å¹¶ç”Ÿæˆ JSON é…ç½®æ¨¡æ¿ã€‚æ”¯æŒè¯­ä¹‰æ¨¡å¼å’Œæ–‡æœ¬æ¨¡å¼ã€‚
            </p>
            <ul class="tool-card-features">
                <li>è‡ªåŠ¨æå– PPT å…ƒç´ </li>
                <li>æ™ºèƒ½è¯†åˆ«å‘½åè§„èŒƒ</li>
                <li>ç”Ÿæˆæ ‡å‡† JSON æ ¼å¼</li>
            </ul>
            <a href="{% url 'config_generator_page' %}" class="tool-card-action tool-card-action-secondary">
                å¼€å§‹ç”Ÿæˆ â†’
            </a>
        </div>
    </div>

    <!-- é…ç½®æ¨¡æ¿ç¼–è¾‘ -->
    <div class="tool-card">
        <div class="tool-card-header gradient-green">
            <div class="tool-card-icon">âœï¸</div>
            <h3 class="tool-card-title">é…ç½®æ¨¡æ¿ç¼–è¾‘</h3>
            <p class="tool-card-subtitle">ç¼–è¾‘ç°æœ‰ JSON é…ç½®</p>
        </div>
        <div class="tool-card-body">
            <p class="tool-card-description">
                ä¸Šä¼ å·²æœ‰çš„ JSON é…ç½®æ¨¡æ¿è¿›è¡Œç¼–è¾‘ï¼Œè°ƒæ•´å­—æ®µå±æ€§ã€æ·»åŠ æç¤ºä¿¡æ¯ã€‚æ”¯æŒ AI è‡ªåŠ¨å¡«å……åŠŸèƒ½ã€‚
            </p>
            <ul class="tool-card-features">
                <li>å¯è§†åŒ–ç¼–è¾‘ç•Œé¢</li>
                <li>AI ä¸€é”®å¡«å……å­—æ®µ</li>
                <li>å®æ—¶é¢„è§ˆä¸å¯¼å‡º</li>
            </ul>
            <a href="{% url 'config_editor_page' %}" class="tool-card-action tool-card-action-secondary">
                å¼€å§‹ç¼–è¾‘ â†’
            </a>
        </div>
    </div>
</div>

<!-- ç¼–è¾‘è®°å½•åŒºåŸŸ -->
<div id="editSessionsSection" class="edit-sessions-section" style="margin-top: var(--spacing-xl);">
    <div class="section-header"
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
        <h3 style="margin: 0;">ğŸ“‚ æœ€è¿‘ç¼–è¾‘è®°å½•</h3>
        <button id="refreshSessionsBtn" class="btn-icon" title="åˆ·æ–°åˆ—è¡¨">ğŸ”„</button>
    </div>
    <div id="editSessionsList" class="edit-sessions-list">
        <p class="loading-text">åŠ è½½ä¸­...</p>
    </div>
</div>

<style>
    .edit-sessions-section {
        background: white;
        border-radius: 16px;
        padding: var(--spacing-lg);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .edit-sessions-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: var(--spacing-md);
    }

    .session-card {
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: var(--spacing-md);
        display: flex;
        gap: var(--spacing-md);
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .session-card:hover {
        border-color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.15);
        transform: translateY(-2px);
    }

    .session-thumbnail {
        width: 80px;
        height: 60px;
        background: var(--bg-secondary);
        border-radius: var(--radius-sm);
        overflow: hidden;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .session-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .session-thumbnail-placeholder {
        font-size: 1.5rem;
        color: var(--text-secondary);
    }

    .session-info {
        flex: 1;
        min-width: 0;
    }

    .session-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
    }

    .session-name {
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
        min-width: 0;
    }

    .session-meta {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .session-progress {
        font-size: 0.8rem;
        color: var(--primary-color);
        margin-top: 4px;
    }

    .session-actions {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .btn-icon {
        background: none;
        border: none;
        font-size: 1rem;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: var(--radius-sm);
        transition: background 0.2s;
    }

    .btn-icon:hover {
        background: var(--bg-hover);
    }

    .btn-icon-danger:hover {
        background: #ffe0e0;
    }

    .empty-sessions {
        text-align: center;
        padding: var(--spacing-xl);
        color: var(--text-secondary);
    }

    .session-type-badge {
        display: inline-block;
        padding: 2px 8px;
        font-size: 0.7rem;
        border-radius: 4px;
        flex-shrink: 0;
        white-space: nowrap;
    }

    .session-type-ppt {
        background: #e8d4f8;
        color: #6b21a8;
    }

    .session-type-config {
        background: #d4edda;
        color: #155724;
    }

    .session-type-wizard {
        background: linear-gradient(135deg, #e8d4f8 0%, #d4e4fd 100%);
        color: #5b21b6;
    }
</style>

<script>
    // åŠ è½½ç¼–è¾‘è®°å½•
    async function loadEditSessions() {
        const listEl = document.getElementById('editSessionsList');
        listEl.innerHTML = '<p class="loading-text">åŠ è½½ä¸­...</p>';

        try {
            const response = await fetch('/developer-tools/edit-sessions/');
            const data = await response.json();

            console.log('All sessions from API:', data.sessions);
            if (data.sessions && data.sessions.length > 0) {
                // è¿‡æ»¤æ‰æ¥è‡ªå‘å¯¼çš„ ppt/config sessionï¼ˆå®ƒä»¬çš„ progress_data.from_wizard = trueï¼‰
                const filteredSessions = data.sessions.filter(session => {
                    // å‘å¯¼ç±»å‹å§‹ç»ˆæ˜¾ç¤º
                    if (session.editor_type === 'wizard') return true;
                    // æ£€æŸ¥æ˜¯å¦æ¥è‡ªå‘å¯¼
                    const progressData = session.progress_data || {};
                    return !progressData.from_wizard;
                });
                console.log('Filtered sessions:', filteredSessions);

                const getTypeBadge = (type) => {
                    if (type === 'wizard') return { icon: 'ğŸ§™â€â™‚ï¸', label: 'å‘å¯¼' };
                    if (type === 'ppt') return { icon: 'ğŸ¨', label: 'PPT' };
                    return { icon: 'ğŸ“„', label: 'é…ç½®' };
                };

                if (filteredSessions.length === 0) {
                    listEl.innerHTML = '<div class="empty-sessions">æš‚æ— ç¼–è¾‘è®°å½•<br><small>ä¸Šä¼ æ¨¡æ¿åï¼Œç¼–è¾‘è®°å½•ä¼šè‡ªåŠ¨ä¿å­˜åœ¨è¿™é‡Œ</small></div>';
                    return;
                }

                listEl.innerHTML = filteredSessions.map(session => {
                    const typeBadge = getTypeBadge(session.editor_type);
                    return `
                    <div class="session-card" onclick="openSession('${session.session_id}', '${session.editor_type}')">
                        <div class="session-thumbnail">
                            ${session.thumbnail_url
                            ? `<img src="${session.thumbnail_url}" alt="é¢„è§ˆ">`
                            : `<span class="session-thumbnail-placeholder">${typeBadge.icon}</span>`
                        }
                        </div>
                        <div class="session-info">
                            <div class="session-header">
                                <span class="session-name">${escapeHtml(session.template_name)}</span>
                                <span class="session-type-badge session-type-${session.editor_type}">${typeBadge.label}</span>
                            </div>
                            <div class="session-meta">æ›´æ–°äº ${session.updated_at}</div>
                            <div class="session-progress">${session.progress_summary}</div>
                        </div>
                        <div class="session-actions" onclick="event.stopPropagation()">
                            <button class="btn-icon btn-icon-danger" onclick="deleteSession('${session.session_id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `}).join('');
            } else {
                listEl.innerHTML = '<div class="empty-sessions">æš‚æ— ç¼–è¾‘è®°å½•<br><small>ä¸Šä¼ æ¨¡æ¿åï¼Œç¼–è¾‘è®°å½•ä¼šè‡ªåŠ¨ä¿å­˜åœ¨è¿™é‡Œ</small></div>';
            }
        } catch (error) {
            listEl.innerHTML = '<div class="empty-sessions">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
            console.error('åŠ è½½ç¼–è¾‘è®°å½•å¤±è´¥:', error);
        }
    }

    // æ‰“å¼€ç¼–è¾‘ä¼šè¯
    function openSession(sessionId, editorType) {
        if (editorType === 'wizard') {
            window.location.href = `/developer-tools/template-wizard/?session=${sessionId}`;
        } else if (editorType === 'ppt') {
            window.location.href = `/developer-tools/template-editor/?session=${sessionId}`;
        } else {
            window.location.href = `/developer-tools/config-editor/?session=${sessionId}`;
        }
    }

    // åˆ é™¤ç¼–è¾‘ä¼šè¯
    async function deleteSession(sessionId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¼–è¾‘è®°å½•å—ï¼Ÿ\n\nåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) {
            return;
        }

        try {
            const response = await fetch(`/developer-tools/edit-sessions/${sessionId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            if (response.ok) {
                loadEditSessions();
            } else {
                const data = await response.json();
                alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            alert('åˆ é™¤å¤±è´¥: ' + error.message);
        }
    }

    // è·å– CSRF Token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // HTML è½¬ä¹‰
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
        loadEditSessions();
        document.getElementById('refreshSessionsBtn').addEventListener('click', loadEditSessions);
    });
</script>
{% endblock %}