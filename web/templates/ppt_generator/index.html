{% extends 'base.html' %}

{% block title %}ç”ŸæˆPPT - S2S{% endblock %}

{% block content %}
<div class="page-header">
    <h2>ğŸ“ ç”ŸæˆPPTæ¼”ç¤ºæ–‡ç¨¿</h2>
    <p class="subtitle">ä¸Šä¼ è®²ç¨¿æ–‡æ¡£ï¼Œé€‰æ‹©æ¨¡æ¿ï¼Œä¸€é”®ç”Ÿæˆç²¾ç¾PPT</p>
</div>

<div class="grid-container">
    <!-- Upload Form Section -->
    <div class="card card-primary">
        <div class="card-header">
            <h3>ğŸ“¤ ä¸Šä¼ æ–‡ä»¶</h3>
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" id="uploadForm">
                {% csrf_token %}

                <!-- DOCX File Upload -->
                <div class="form-group">
                    <label for="{{ form.docx_file.id_for_label }}" class="form-label required">
                        {{ form.docx_file.label }}
                    </label>
                    <div class="file-upload-wrapper">
                        {{ form.docx_file }}
                        <span class="file-upload-label">é€‰æ‹©è®²ç¨¿æ–‡ä»¶ (.docx)</span>
                    </div>
                    {% if form.docx_file.help_text %}
                    <small class="form-help">{{ form.docx_file.help_text }}</small>
                    {% endif %}
                    {% if form.docx_file.errors %}
                    <div class="form-error">{{ form.docx_file.errors }}</div>
                    {% endif %}
                </div>

                <!-- Template Selection -->
                <div class="form-group">
                    <label class="form-label required">{{ form.template_choice.label }}</label>
                    <div class="radio-group">
                        {% for choice in form.template_choice %}
                        <label class="radio-label">
                            {{ choice.tag }}
                            <span>{{ choice.choice_label }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Preset Template Selection (shown when 'preset' is selected) -->
                <div class="form-group" id="presetTemplateGroup" style="display: none;">
                    <label class="form-label">é€‰æ‹©é¢„è®¾æ¨¡æ¿</label>
                    <select name="preset_template_path" class="text-input">
                        {% for tmpl in available_templates %}
                        <option value="{{ tmpl.path }}">{{ tmpl.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Custom Template Upload (shown when 'upload' is selected) -->
                <div class="form-group" id="customTemplateGroup" style="display: none;">
                    <label for="{{ form.template_file.id_for_label }}" class="form-label">
                        {{ form.template_file.label }}
                    </label>
                    <div class="file-upload-wrapper">
                        {{ form.template_file }}
                        <span class="file-upload-label">é€‰æ‹©æ¨¡æ¿æ–‡ä»¶ (.pptx)</span>
                    </div>
                    {% if form.template_file.help_text %}
                    <small class="form-help">{{ form.template_file.help_text }}</small>
                    {% endif %}
                </div>

                <!-- LLM Configuration Section -->
                <div class="form-section">
                    <h4>ğŸ¤– å¤§æ¨¡å‹é…ç½®
                        {% if is_developer %}
                        <span style="color: var(--warning-color); font-size: 0.8rem;">(å¼€å‘è€…åŠŸèƒ½)</span>
                        {% endif %}
                    </h4>

                    <!-- Use LLM Checkbox (All Users) -->
                    <div class="form-group">
                        <label class="checkbox-label">
                            {{ form.use_llm }}
                            <span>{{ form.use_llm.label }}</span>
                        </label>
                        <small class="form-help">{{ form.use_llm.help_text }}</small>
                    </div>

                    {% if is_developer %}
                    <!-- Developer-only LLM Configuration -->
                    <div id="llmConfigSection" style="display: none;">
                        <!-- Config Template Selection (developer only, shown when LLM is enabled) -->
                        <div class="form-group">
                            <label class="form-label">{{ form.config_template_choice.label }}</label>
                            <div class="radio-group">
                                {% for choice in form.config_template_choice %}
                                <label class="radio-label">
                                    {{ choice.tag }}
                                    <span>{{ choice.choice_label }}</span>
                                </label>
                                {% endfor %}
                            </div>
                            <small class="form-help">
                                é…ç½®æ¨¡æ¿ç”¨äºæ§åˆ¶å¤§æ¨¡å‹çš„ Prompt å’Œç”Ÿæˆè§„åˆ™
                            </small>
                        </div>

                        <!-- Config Template Dropdown (shown when 'select' is chosen) -->
                        <div class="form-group" id="configTemplateSelectGroup" style="display: none;">
                            <label class="form-label">é€‰æ‹©é…ç½®æ¨¡æ¿</label>
                            <select name="config_template" class="text-input">
                                <option value="">-- è¯·é€‰æ‹© --</option>
                                {% for cfg in available_config_templates %}
                                <option value="{{ cfg }}" {% if form.config_template.value == cfg %}selected{% endif %}>
                                    {{ cfg }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Config Template Upload (shown when 'upload' is chosen) -->
                        <div class="form-group" id="configTemplateUploadGroup" style="display: none;">
                            <label for="{{ form.config_template_file.id_for_label }}" class="form-label">
                                ä¸Šä¼ é…ç½®æ¨¡æ¿æ–‡ä»¶
                            </label>
                            <div class="file-upload-wrapper">
                                {{ form.config_template_file }}
                                <span class="file-upload-label">é€‰æ‹©é…ç½®æ–‡ä»¶ (.json)</span>
                            </div>
                            {% if form.config_template_file.help_text %}
                            <small class="form-help">{{ form.config_template_file.help_text }}</small>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.llm_provider.id_for_label }}" class="form-label">
                                {{ form.llm_provider.label }}
                            </label>
                            {{ form.llm_provider }}
                            <small class="form-help">é€‰æ‹©å¤§æ¨¡å‹ä¾›åº”å•†ä»¥å¯ç”¨æ™ºèƒ½è§„åˆ’åŠŸèƒ½</small>
                        </div>

                        <div class="form-group" id="llmModelGroup" style="display: none;">
                            <label for="{{ form.llm_model.id_for_label }}" class="form-label">
                                {{ form.llm_model.label }}
                            </label>
                            {{ form.llm_model }}
                            <small class="form-help">DeepSeek: deepseek-chat æˆ– deepseek-reasoner</small>
                        </div>

                        <div class="form-group" id="llmApiKeyGroup" style="display: none;">
                            <label for="{{ form.llm_api_key.id_for_label }}" class="form-label">
                                {{ form.llm_api_key.label }}
                            </label>
                            {{ form.llm_api_key }}
                            <small class="form-help">è¾“å…¥æ‚¨çš„APIå¯†é’¥</small>
                        </div>

                        <div class="form-group" id="llmBaseUrlGroup" style="display: none;">
                            <label for="{{ form.llm_base_url.id_for_label }}" class="form-label">
                                {{ form.llm_base_url.label }}
                            </label>
                            {{ form.llm_base_url }}
                            <small class="form-help">è‡ªå®šä¹‰æœåŠ¡å™¨åœ°å€ï¼ˆå¯é€‰ï¼‰</small>
                        </div>

                        <div class="form-group" id="userPromptGroup" style="display: none;">
                            <label for="{{ form.user_prompt.id_for_label }}" class="form-label">
                                {{ form.user_prompt.label }}
                            </label>
                            {{ form.user_prompt }}
                            <small class="form-help">é¢å¤–çš„æç¤ºè¯å°†é™„åŠ åˆ°ç³»ç»Ÿé»˜è®¤æç¤ºè¯ä¹‹å</small>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Optional Metadata -->
                <div class="form-section">
                    <h4>ğŸ“‹ å¯é€‰ä¿¡æ¯</h4>

                    <div class="form-group">
                        <label for="{{ form.course_name.id_for_label }}" class="form-label">
                            {{ form.course_name.label }}
                        </label>
                        {{ form.course_name }}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.college_name.id_for_label }}" class="form-label">
                            {{ form.college_name.label }}
                        </label>
                        {{ form.college_name }}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.lecturer_name.id_for_label }}" class="form-label">
                            {{ form.lecturer_name.label }}
                        </label>
                        {{ form.lecturer_name }}
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-large">
                        ğŸš€ å¼€å§‹ç”ŸæˆPPT
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Recent Generations Section -->
    <div class="card">
        <div class="card-header">
            <h3>ğŸ“œ æœ€è¿‘ç”Ÿæˆ</h3>
        </div>
        <div class="card-body">
            {% if recent_generations %}
            <div class="generation-list">
                {% for gen in recent_generations %}
                <a href="{% url 'generation_detail' gen.pk %}" class="generation-item">
                    <div class="generation-status status-{{ gen.status }}">
                        {{ gen.get_status_display }}
                    </div>
                    <div class="generation-info">
                        <div class="generation-title">
                            {% if gen.course_name %}
                            {{ gen.course_name }}
                            {% else %}
                            ç”Ÿæˆ #{{ gen.id }}
                            {% endif %}
                        </div>
                        <div class="generation-meta">
                            {{ gen.created_at|date:"Y-m-d H:i" }}
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <p class="empty-state">æš‚æ— ç”Ÿæˆè®°å½•</p>
            {% endif %}

            <a href="{% url 'history' %}" class="btn btn-secondary btn-block">æŸ¥çœ‹å…¨éƒ¨å†å²</a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Show/hide custom template upload based on selection
    document.addEventListener('DOMContentLoaded', function () {
        const templateChoices = document.querySelectorAll('input[name="template_choice"]');
        const customTemplateGroup = document.getElementById('customTemplateGroup');

        const presetTemplateGroup = document.getElementById('presetTemplateGroup');

        templateChoices.forEach(radio => {
            radio.addEventListener('change', function () {
                if (this.value === 'upload') {
                    customTemplateGroup.style.display = 'block';
                    presetTemplateGroup.style.display = 'none';
                } else if (this.value === 'preset') {
                    customTemplateGroup.style.display = 'none';
                    presetTemplateGroup.style.display = 'block';
                }
            });
        });

        // Initialize on page load
        const checkedTemplate = document.querySelector('input[name="template_choice"]:checked');
        if (checkedTemplate) {
            if (checkedTemplate.value === 'upload') {
                customTemplateGroup.style.display = 'block';
            } else if (checkedTemplate.value === 'preset') {
                presetTemplateGroup.style.display = 'block';
            }
        }

        // Show/hide config template options based on selection (for developers)
        const configTemplateChoices = document.querySelectorAll('input[name="config_template_choice"]');
        const configTemplateSelectGroup = document.getElementById('configTemplateSelectGroup');
        const configTemplateUploadGroup = document.getElementById('configTemplateUploadGroup');

        if (configTemplateChoices.length > 0) {
            configTemplateChoices.forEach(radio => {
                radio.addEventListener('change', function () {
                    if (this.value === 'select') {
                        configTemplateSelectGroup.style.display = 'block';
                        configTemplateUploadGroup.style.display = 'none';
                    } else if (this.value === 'upload') {
                        configTemplateSelectGroup.style.display = 'none';
                        configTemplateUploadGroup.style.display = 'block';
                    } else {
                        // 'auto' - hide both
                        configTemplateSelectGroup.style.display = 'none';
                        configTemplateUploadGroup.style.display = 'none';
                    }
                });
            });

            // Initialize on page load
            const checkedConfigChoice = document.querySelector('input[name="config_template_choice"]:checked');
            if (checkedConfigChoice) {
                if (checkedConfigChoice.value === 'select') {
                    configTemplateSelectGroup.style.display = 'block';
                } else if (checkedConfigChoice.value === 'upload') {
                    configTemplateUploadGroup.style.display = 'block';
                }
            }
        }

        // Show/hide LLM configuration section based on use_llm checkbox (for developers)
        const useLlmCheckbox = document.getElementById('id_use_llm');
        const llmConfigSection = document.getElementById('llmConfigSection');

        if (useLlmCheckbox && llmConfigSection) {
            useLlmCheckbox.addEventListener('change', function () {
                if (this.checked) {
                    llmConfigSection.style.display = 'block';
                } else {
                    llmConfigSection.style.display = 'none';
                }
            });

            // Initialize on page load
            if (useLlmCheckbox.checked) {
                llmConfigSection.style.display = 'block';
            }
        }

        // Show/hide LLM configuration fields based on provider selection (for developers)
        const llmProvider = document.getElementById('id_llm_provider');
        const llmModelGroup = document.getElementById('llmModelGroup');
        const llmApiKeyGroup = document.getElementById('llmApiKeyGroup');
        const llmBaseUrlGroup = document.getElementById('llmBaseUrlGroup');
        const userPromptGroup = document.getElementById('userPromptGroup');
        const llmModelInput = document.getElementById('id_llm_model');

        if (llmProvider) {
            function updateLLMFields() {
                const provider = llmProvider.value;

                if (!provider) {
                    // No provider selected - hide all LLM fields
                    llmModelGroup.style.display = 'none';
                    llmApiKeyGroup.style.display = 'none';
                    llmBaseUrlGroup.style.display = 'none';
                    userPromptGroup.style.display = 'none';
                } else {
                    // Provider selected - show relevant fields
                    llmModelGroup.style.display = 'block';
                    llmApiKeyGroup.style.display = 'block';
                    userPromptGroup.style.display = 'block';

                    // Set default model based on provider
                    if (provider === 'deepseek') {
                        llmModelInput.value = llmModelInput.value || 'deepseek-chat';
                        llmModelInput.placeholder = 'deepseek-chat æˆ– deepseek-reasoner';
                        llmBaseUrlGroup.style.display = 'none';
                    } else if (provider === 'local') {
                        llmModelInput.value = llmModelInput.value || 'Qwen3-8B';
                        llmModelInput.placeholder = 'ä¾‹å¦‚ï¼šQwen3-8B';
                        llmBaseUrlGroup.style.display = 'block';
                    } else if (provider === 'custom') {
                        llmModelInput.placeholder = 'è¾“å…¥æ¨¡å‹åç§°';
                        llmBaseUrlGroup.style.display = 'block';
                    }
                }
            }

            llmProvider.addEventListener('change', updateLLMFields);
            updateLLMFields(); // Initialize on page load
        }
    });
</script>
{% endblock %}