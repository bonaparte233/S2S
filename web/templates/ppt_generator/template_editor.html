{% extends 'base.html' %}
{% load static %}

{% block title %}PPT æ¨¡æ¿ç¼–è¾‘å™¨ - S2S{% endblock %}

{% block extra_css %}
<style>
    /* æ¨¡æ¿ç¼–è¾‘å™¨å…¨å±å¸ƒå±€ */
    html,
    body {
        height: 100%;
        margin: 0;
        overflow: hidden;
    }

    /* éšè—ä¸»é¡µå¯¼èˆªæ ï¼Œç¼–è¾‘å™¨æœ‰è‡ªå·±çš„é¡¶æ  */
    .navbar {
        display: none !important;
    }

    /* è¦†ç›– base.html ä¸­çš„å®¹å™¨æ ·å¼ */
    .main-content {
        padding: 0 !important;
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
        /* é‡è¦ï¼šå…è®¸ flex å­å…ƒç´ æ”¶ç¼© */
    }

    .main-content>.container {
        max-width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        /* é‡è¦ï¼šå…è®¸ flex å­å…ƒç´ æ”¶ç¼© */
    }

    .footer {
        display: none !important;
    }

    /* å…¨å±ç¼–è¾‘å™¨å®¹å™¨ */
    .template-editor-fullscreen-container {
        flex: 1;
        background: var(--bg-color);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-height: 0;
        /* é‡è¦ï¼šå…è®¸ flex å­å…ƒç´ æ”¶ç¼© */
    }

    /* é¡¶éƒ¨å·¥å…·æ  */
    .editor-toolbar {
        height: 70px;
        background: white;
        border-bottom: 1px solid var(--border-color);
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        padding: 0 var(--spacing-xl);
        flex-shrink: 0;
    }

    .editor-toolbar>div:first-child {
        justify-self: start;
    }

    .editor-toolbar h2 {
        margin: 0;
        font-size: 1.4rem;
        color: var(--text-primary);
        text-align: center;
    }

    .editor-toolbar>div:last-child {
        justify-self: end;
    }

    .toolbar-actions {
        display: flex;
        gap: var(--spacing-sm);
    }

    /* ä¸»ç¼–è¾‘åŒºåŸŸ */
    .editor-main {
        flex: 1;
        display: flex;
        overflow: hidden;
        min-height: 0;
        /* é‡è¦ï¼šå…è®¸ flex å­å…ƒç´ æ”¶ç¼© */
    }

    /* å·¦ä¾§é¡µé¢åˆ—è¡¨ */
    .editor-sidebar-left {
        width: 220px;
        background: white;
        border-right: 1px solid var(--border-color);
        overflow-y: auto;
        flex-shrink: 0;
    }

    /* ä¸­é—´ Canvas é¢„è§ˆåŒº */
    .editor-canvas-area {
        flex: 1;
        background: #f5f5f5;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-height: 0;
        /* é‡è¦ï¼šå…è®¸ flex å­å…ƒç´ æ”¶ç¼© */
    }

    .canvas-toolbar {
        height: 50px;
        background: white;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 var(--spacing-md);
        flex-shrink: 0;
    }

    .canvas-container {
        flex: 1;
        overflow: auto;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 0;
        /* é‡è¦ï¼šå…è®¸ flex å­å…ƒç´ æ”¶ç¼© */
    }

    /* å³ä¾§å±æ€§é¢æ¿ */
    .editor-sidebar-right {
        width: 320px;
        background: white;
        border-left: 1px solid var(--border-color);
        overflow-y: auto;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
    }

    /* é¡µé¢åˆ—è¡¨é¡¹ */
    .page-item {
        padding: var(--spacing-md);
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .page-item:hover {
        background: var(--bg-hover);
    }

    .page-item.active {
        background: var(--primary-color);
        color: white;
    }

    .page-item-title {
        font-weight: 600;
        margin-bottom: 4px;
    }

    .page-item-info {
        font-size: 0.85rem;
        opacity: 0.8;
    }

    /* å±æ€§é¢æ¿ Tab */
    .property-tabs {
        display: flex;
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0;
    }

    .property-tab {
        flex: 1;
        padding: var(--spacing-sm);
        border: none;
        background: none;
        cursor: pointer;
        font-size: 0.9rem;
        color: var(--text-secondary);
        transition: all 0.2s ease;
        border-bottom: 2px solid transparent;
    }

    .property-tab.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
        font-weight: 600;
    }

    .property-content {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-md);
    }

    /* å…ƒç´ åˆ—è¡¨ */
    .element-item {
        padding: var(--spacing-sm);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        margin-bottom: var(--spacing-sm);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .element-item:hover {
        border-color: var(--primary-color);
        background: var(--bg-hover);
    }

    .element-item.selected {
        border-color: var(--primary-color);
        background: rgba(52, 152, 219, 0.1);
    }

    .element-number {
        display: inline-block;
        width: 24px;
        height: 24px;
        line-height: 24px;
        text-align: center;
        border-radius: 50%;
        background: var(--primary-color);
        color: white;
        font-size: 0.85rem;
        font-weight: 600;
        margin-right: var(--spacing-sm);
    }

    .element-item.unnamed .element-number {
        background: var(--warning-color);
    }
</style>
{% endblock %}

{% block content %}
<!-- ä¸Šä¼ åŒºåŸŸï¼ˆåˆå§‹æ˜¾ç¤ºï¼‰ -->
<div id="uploadSection" class="template-editor-fullscreen-container">
    <div class="editor-toolbar">
        <div>
            <a href="{% url 'developer_tools' %}" class="btn btn-secondary">
                â† è¿”å›å¼€å‘è€…å·¥å…·
            </a>
        </div>
        <h2>ğŸ¨ PPT æ¨¡æ¿ç¼–è¾‘å™¨</h2>
        <div></div>
    </div>

    <div class="editor-main" style="align-items: center; justify-content: center;">
        <div class="card" style="max-width: 600px; width: 100%; margin: var(--spacing-xl);">
            <div class="card-header">
                <h3>ğŸ“¤ ä¸Šä¼  PPT æ¨¡æ¿</h3>
            </div>
            <div class="card-body">
                <form id="uploadTemplateForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="form-group">
                        <label class="form-label">é€‰æ‹© PPT æ–‡ä»¶</label>
                        <div class="file-upload-wrapper">
                            <input type="file" id="pptFileInput" name="ppt_file" accept=".pptx" required>
                            <label for="pptFileInput" class="file-upload-label">
                                <span id="fileNameDisplay">ğŸ“ ç‚¹å‡»é€‰æ‹© PPT æ–‡ä»¶</span>
                            </label>
                        </div>
                        <p style="margin-top: var(--spacing-sm); font-size: 0.9rem; color: var(--text-secondary);">
                            æ”¯æŒ .pptx æ ¼å¼ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è½¬æ¢ä¸º PDF å¹¶ç”Ÿæˆé¢„è§ˆ
                        </p>
                    </div>

                    <div style="margin-top: var(--spacing-lg);">
                        <button type="submit" class="btn btn-primary btn-large" style="width: 100%;">
                            ğŸš€ å¼€å§‹ç¼–è¾‘
                        </button>
                    </div>
                </form>

                <div
                    style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--border-radius);">
                    <h4 style="margin-top: 0;">ğŸ“– ä½¿ç”¨è¯´æ˜</h4>
                    <ol style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">
                        <li>ä¸Šä¼  PPT æ¨¡æ¿æ–‡ä»¶ï¼ˆ.pptx æ ¼å¼ï¼‰</li>
                        <li>ç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨ LibreOffice è½¬æ¢ä¸º PDF å¹¶ç”Ÿæˆé¢„è§ˆ</li>
                        <li>ç³»ç»Ÿä¼šè‡ªåŠ¨æå–æ‰€æœ‰å¯ç¼–è¾‘å…ƒç´ å¹¶æ ‡æ³¨ç¼–å·ï¼ˆâ‘ â‘¡â‘¢...ï¼‰</li>
                        <li>ç‚¹å‡»é¢„è§ˆåŒºçš„å…ƒç´ æˆ–ç¼–å·ï¼Œåœ¨å³ä¾§é¢æ¿ä¸ºå…ƒç´ å‘½å</li>
                        <li>ä½¿ç”¨è¯­ä¹‰åŒ–åç§°ï¼Œå¦‚"æ ‡é¢˜åŒº"ã€"ä½œè€…å"ã€"ä¸»è¦å†…å®¹"ç­‰</li>
                        <li>å®Œæˆåç‚¹å‡»"ä¿å­˜ PPT"å’Œ"ç”Ÿæˆé…ç½® JSON"</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç¼–è¾‘å™¨åŒºåŸŸï¼ˆä¸Šä¼ æˆåŠŸåæ˜¾ç¤ºï¼‰ -->
<div id="editorSection" class="template-editor-fullscreen-container" style="display: none;">
    <div class="editor-toolbar">
        <div>
            <a href="{% url 'developer_tools' %}" class="btn btn-secondary">
                â† è¿”å›å¼€å‘è€…å·¥å…·
            </a>
        </div>
        <h2 id="editorTitle">ğŸ¨ PPT æ¨¡æ¿ç¼–è¾‘å™¨</h2>
        <div class="toolbar-actions">
            <button id="saveTemplateBtn" class="btn btn-success">
                ğŸ’¾ ä¿å­˜ PPT
            </button>
            <button id="generateConfigBtn" class="btn btn-primary">
                ğŸ“„ ç”Ÿæˆé…ç½® JSON
            </button>
            <button id="uploadNewBtn" class="btn btn-secondary">
                ğŸ“‚ ä¸Šä¼ å…¶ä»–æ¨¡æ¿
            </button>
        </div>
    </div>

    <div class="editor-main">
        <!-- å·¦ä¾§é¡µé¢åˆ—è¡¨ -->
        <div class="editor-sidebar-left">
            <div
                style="padding: var(--spacing-md); border-bottom: 1px solid var(--border-color); background: var(--bg-secondary);">
                <h4 style="margin: 0; font-size: 0.95rem;">ğŸ“‘ é¡µé¢åˆ—è¡¨</h4>
            </div>
            <!-- è¿›åº¦æ¡ -->
            <div
                style="padding: var(--spacing-sm); border-bottom: 1px solid var(--border-color); background: var(--bg-color);">
                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">
                    å·²å‘½å: <span id="namedCount">0 / 0</span> (<span id="progressPercent">0%</span>)
                </div>
                <div style="height: 4px; background: var(--border-color); border-radius: 2px; overflow: hidden;">
                    <div id="progressBar"
                        style="height: 100%; background: var(--success-color); width: 0%; transition: width 0.3s ease;">
                    </div>
                </div>
            </div>
            <div id="pageList">
                <!-- Pages will be populated here -->
            </div>
        </div>

        <!-- ä¸­é—´ Canvas é¢„è§ˆåŒº -->
        <div class="editor-canvas-area">
            <div class="canvas-toolbar">
                <h4 id="currentPageTitle" style="margin: 0;">ç¬¬ 1 é¡µ</h4>
                <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                    <button id="zoomOutBtn" class="btn btn-secondary btn-small">ğŸ”-</button>
                    <span id="zoomLevel">100%</span>
                    <button id="zoomInBtn" class="btn btn-secondary btn-small">ğŸ”+</button>
                    <button id="fitToWindowBtn" class="btn btn-secondary btn-small">âš™ï¸ é€‚åº”çª—å£</button>
                </div>
            </div>
            <div class="canvas-container" id="canvasContainer">
                <canvas id="previewCanvas" style="display: block; cursor: crosshair;"></canvas>
            </div>
            <div
                style="padding: var(--spacing-sm); background: white; border-top: 1px solid var(--border-color); font-size: 0.85rem; color: var(--text-secondary); text-align: center;">
                ğŸ’¡ å¿«æ·é”®: ç‚¹å‡»å…ƒç´ ç¼–è¾‘ | â†â†’ åˆ‡æ¢é¡µé¢ | +/- ç¼©æ”¾ | 0 é€‚åº”çª—å£ | Shift+æ‹–æ‹½ å¹³ç§»
            </div>
        </div>

        <!-- å³ä¾§å±æ€§é¢æ¿ -->
        <div class="editor-sidebar-right">
            <div class="property-tabs">
                <button id="elementListTabBtn" class="property-tab active" onclick="switchPropertyTab('list')">
                    ğŸ“‹ å…ƒç´ åˆ—è¡¨
                </button>
                <button id="elementEditTabBtn" class="property-tab" onclick="switchPropertyTab('edit')">
                    âœï¸ ç¼–è¾‘å±æ€§
                </button>
            </div>

            <!-- å…ƒç´ åˆ—è¡¨è§†å›¾ -->
            <div id="elementListView" class="property-content">
                <p style="color: var(--text-secondary); text-align: center; padding: var(--spacing-xl);">
                    è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé¡µé¢
                </p>
            </div>

            <!-- ç¼–è¾‘å±æ€§è§†å›¾ -->
            <div id="elementEditView" class="property-content" style="display: none;">
                <p style="color: var(--text-secondary); text-align: center; padding: var(--spacing-xl);">
                    è¯·ç‚¹å‡»å·¦ä¾§é¢„è§ˆåŒºçš„å…ƒç´ å¼€å§‹ç¼–è¾‘
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'js/template-editor.js' %}"></script>
<script>
    console.log('ğŸš€ æ¨¡æ¿ç¼–è¾‘å™¨è„šæœ¬å¼€å§‹åŠ è½½...');

    // ========================================
    // Template Editor State
    // ========================================

    let templateEditorState = {
        templateId: null,
        pptPath: null,
        slideWidth: 12192000,   // å¹»ç¯ç‰‡å®½åº¦ï¼ˆEMUï¼‰
        slideHeight: 6858000,   // å¹»ç¯ç‰‡é«˜åº¦ï¼ˆEMUï¼‰
        pages: [],
        currentPageNum: 1,
        canvasPreview: null,
        imageCache: new Map() // å›¾ç‰‡ç¼“å­˜ï¼Œé¿å…é‡å¤åŠ è½½
    };

    // ========================================
    // Utility Functions
    // ========================================

    // Loading overlay
    function showLoading(message = 'å¤„ç†ä¸­...') {
        let overlay = document.getElementById('loadingOverlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.style.cssText = `
                position: fixed; top: 0; left: 0;
                width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex; flex-direction: column;
                justify-content: center; align-items: center;
                z-index: 9999; color: white; font-size: 1.2rem;
            `;
            overlay.innerHTML = `
                <div style="text-align: center;">
                    <div class="spinner" style="width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                    <div id="loadingMessage">${message}</div>
                </div>
                <style>
                    @keyframes spin {
                        to { transform: rotate(360deg); }
                    }
                </style>
            `;
            document.body.appendChild(overlay);
        } else {
            overlay.style.display = 'flex';
            document.getElementById('loadingMessage').textContent = message;
        }
    }

    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.style.display = 'none';
        }
    }

    // Toast notifications
    function showToast(message, type = 'info') {
        const colors = {
            success: '#2ecc71',
            error: '#e74c3c',
            warning: '#f39c12',
            info: '#3498db'
        };

        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed; top: 20px; right: 20px;
            background: ${colors[type]}; color: white;
            padding: 1rem 1.5rem; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000; font-size: 1rem;
            animation: slideIn 0.3s ease;
        `;
        toast.innerHTML = `
            <style>
                @keyframes slideIn {
                    from { transform: translateX(400px); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            </style>
            ${message}
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideIn 0.3s ease reverse';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function showSuccess(message) { showToast(message, 'success'); }
    function showError(message) { showToast(message, 'error'); }
    function showWarning(message) { showToast(message, 'warning'); }
    function showInfo(message) { showToast(message, 'info'); }

    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Download JSON
    function downloadJSON(data, filename) {
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    }

    // ========================================
    // Template Upload
    // ========================================

    const uploadForm = document.getElementById('uploadTemplateForm');
    console.log('ğŸ“‹ è¡¨å•å…ƒç´ :', uploadForm);

    if (uploadForm) {
        uploadForm.addEventListener('submit', async function (e) {
            console.log('ğŸ“¤ è¡¨å•æäº¤äº‹ä»¶è§¦å‘');
            e.preventDefault();

            const formData = new FormData(this);
            const pptFile = formData.get('ppt_file');
            console.log('ğŸ“„ æ–‡ä»¶:', pptFile ? pptFile.name : 'æœªé€‰æ‹©');

            if (!pptFile || pptFile.size === 0) {
                showWarning('è¯·é€‰æ‹© PPT æ–‡ä»¶');
                return;
            }

            // ç¦ç”¨æäº¤æŒ‰é’®
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'â³ å¤„ç†ä¸­...';

            try {
                console.log('ğŸ”„ å¼€å§‹ä¸Šä¼ ...');
                showLoading('ğŸ“¤ æ­£åœ¨ä¸Šä¼  PPT æ–‡ä»¶...');

                const response = await fetch('/developer-tools/parse-ppt/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: formData
                });

                console.log('ğŸ“¡ å“åº”çŠ¶æ€:', response.status);
                document.getElementById('loadingMessage').textContent = 'ğŸ”„ æ­£åœ¨ä½¿ç”¨ LibreOffice è½¬æ¢ PDF...';

                const data = await response.json();
                console.log('ğŸ“¦ å“åº”æ•°æ®:', data);

                if (response.ok) {
                    document.getElementById('loadingMessage').textContent = 'ğŸ–¼ï¸ æ­£åœ¨ç”Ÿæˆé¢„è§ˆå›¾ç‰‡...';

                    templateEditorState.templateId = data.template_id;
                    templateEditorState.pptPath = data.ppt_path;
                    // ä¿å­˜å¹»ç¯ç‰‡å°ºå¯¸ï¼ˆç”¨äºæ­£ç¡®è®¡ç®—å…ƒç´ ä½ç½®ï¼‰
                    templateEditorState.slideWidth = data.slide_width || 12192000;
                    templateEditorState.slideHeight = data.slide_height || 6858000;
                    templateEditorState.pages = data.pages;
                    templateEditorState.currentPageNum = 1;
                    templateEditorState.imageCache.clear();

                    // æ˜¾ç¤ºç¼–è¾‘å™¨
                    document.getElementById('uploadSection').style.display = 'none';
                    document.getElementById('editorSection').style.display = 'flex';

                    // æ¸²æŸ“é¡µé¢åˆ—è¡¨
                    renderPageList();

                    // åŠ è½½ç¬¬ä¸€é¡µ
                    loadPage(1);

                    hideLoading();
                    showSuccess(`âœ… æ¨¡æ¿è§£ææˆåŠŸï¼å…± ${data.pages.length} é¡µï¼Œä½¿ç”¨æ‡’åŠ è½½æå‡é€Ÿåº¦`);
                } else {
                    hideLoading();
                    showError('âŒ è§£æå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                hideLoading();
                showError('âŒ ä¸Šä¼ å¤±è´¥: ' + error.message);
                console.error('Upload error:', error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
        console.log('âœ… è¡¨å•äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®š');
    } else {
        console.error('âŒ æœªæ‰¾åˆ°è¡¨å•å…ƒç´  #uploadTemplateForm');
    }

    // ========================================
    // File Input Display
    // ========================================

    const fileInput = document.getElementById('pptFileInput');
    const fileNameDisplay = document.getElementById('fileNameDisplay');

    if (fileInput && fileNameDisplay) {
        fileInput.addEventListener('change', function () {
            if (this.files && this.files[0]) {
                fileNameDisplay.textContent = 'ğŸ“„ ' + this.files[0].name;
                fileNameDisplay.style.color = 'var(--success-color)';
            } else {
                fileNameDisplay.textContent = 'ğŸ“ ç‚¹å‡»é€‰æ‹© PPT æ–‡ä»¶';
                fileNameDisplay.style.color = '';
            }
        });
    }

    // ========================================
    // Page List Rendering
    // ========================================

    function renderPageList() {
        const pageList = document.getElementById('pageList');
        pageList.innerHTML = '';

        templateEditorState.pages.forEach((page, index) => {
            const totalShapes = page.shapes.filter(s => !s.is_hidden).length;
            const namedShapes = page.shapes.filter(s => !s.is_hidden && s.is_named).length;
            const percent = totalShapes > 0 ? Math.round(namedShapes / totalShapes * 100) : 0;

            const pageItem = document.createElement('div');
            pageItem.className = 'page-item' + (page.page_num === templateEditorState.currentPageNum ? ' active' : '');
            pageItem.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-weight: bold;">ç¬¬ ${page.page_num} é¡µ</span>
                    <span style="font-size: 0.85rem; color: ${percent === 100 ? 'var(--success-color)' : 'var(--text-secondary)'};">
                        ${percent}%
                    </span>
                </div>
                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                    ${namedShapes} / ${totalShapes} å·²å‘½å
                </div>
                <div style="height: 4px; background: var(--border-color); border-radius: 2px; overflow: hidden;">
                    <div style="height: 100%; background: var(--success-color); width: ${percent}%; transition: width 0.3s ease;"></div>
                </div>
            `;
            pageItem.onclick = () => loadPage(page.page_num);
            pageList.appendChild(pageItem);
        });
    }

    // ========================================
    // Page Loading (Lazy Loading + Caching)
    // ========================================

    function loadPage(pageNum) {
        const page = templateEditorState.pages.find(p => p.page_num === pageNum);
        if (!page) return;

        templateEditorState.currentPageNum = pageNum;

        // æ›´æ–°é¡µé¢æ ‡é¢˜
        document.getElementById('currentPageTitle').textContent = `ç¬¬ ${pageNum} é¡µ`;

        // æ›´æ–°é¡µé¢åˆ—è¡¨é«˜äº®
        document.querySelectorAll('#pageList .page-item').forEach((item, index) => {
            item.classList.toggle('active', index + 1 === pageNum);
        });

        // æ£€æŸ¥ç¼“å­˜
        if (templateEditorState.imageCache.has(page.image_url)) {
            renderCanvas(page);
            return;
        }

        // æ˜¾ç¤ºåŠ è½½æç¤º
        showLoading(`ğŸ–¼ï¸ æ­£åœ¨åŠ è½½ç¬¬ ${pageNum} é¡µé¢„è§ˆå›¾ç‰‡...`);

        // æ‡’åŠ è½½å›¾ç‰‡
        const img = new Image();
        img.onload = () => {
            templateEditorState.imageCache.set(page.image_url, img);
            renderCanvas(page);
            hideLoading();
        };

        img.onerror = () => {
            hideLoading();
            showError(`åŠ è½½ç¬¬ ${pageNum} é¡µå›¾ç‰‡å¤±è´¥`);
        };

        img.src = page.image_url;
    }

    // ========================================
    // Canvas Rendering
    // ========================================

    function renderCanvas(page) {
        if (templateEditorState.canvasPreview) {
            templateEditorState.canvasPreview.screenshotUrl = page.image_url;
            templateEditorState.canvasPreview.shapes = page.shapes;
            // æ›´æ–°å¹»ç¯ç‰‡å°ºå¯¸ï¼ˆä»¥é˜²ä¸åŒæ¨¡æ¿å°ºå¯¸ä¸åŒï¼‰
            templateEditorState.canvasPreview.slideWidth = templateEditorState.slideWidth;
            templateEditorState.canvasPreview.slideHeight = templateEditorState.slideHeight;
            templateEditorState.canvasPreview.init();
        } else {
            templateEditorState.canvasPreview = new CanvasPreview(
                'previewCanvas',
                page.image_url,
                page.shapes,
                templateEditorState.slideWidth,
                templateEditorState.slideHeight
            );

            // ç›‘å¬å…ƒç´ é€‰ä¸­äº‹ä»¶
            document.getElementById('previewCanvas').addEventListener('shapeSelected', (e) => {
                renderPropertyPanel(e.detail);
            });
        }

        // æ¸²æŸ“å…ƒç´ åˆ—è¡¨
        renderElementList();

        // æ›´æ–°è¿›åº¦
        updateProgress();

        // é¢„åŠ è½½ä¸‹ä¸€é¡µ
        preloadNextPage(page.page_num);
    }

    // é¢„åŠ è½½ä¸‹ä¸€é¡µå›¾ç‰‡
    function preloadNextPage(currentPageNum) {
        const nextPage = templateEditorState.pages.find(p => p.page_num === currentPageNum + 1);
        if (!nextPage) return;

        if (templateEditorState.imageCache.has(nextPage.image_url)) return;

        const img = new Image();
        img.onload = () => {
            templateEditorState.imageCache.set(nextPage.image_url, img);
            console.log(`âœ… é¢„åŠ è½½ç¬¬ ${nextPage.page_num} é¡µå®Œæˆ`);
        };
        img.onerror = () => {
            console.warn(`âš ï¸ é¢„åŠ è½½ç¬¬ ${nextPage.page_num} é¡µå¤±è´¥`);
        };
        img.src = nextPage.image_url;
    }

    // ========================================
    // Property Panel
    // ========================================

    // Switch property tabs
    function switchPropertyTab(tab) {
        const tabs = document.querySelectorAll('.property-tab');
        const listView = document.getElementById('elementListView');
        const editView = document.getElementById('elementEditView');

        if (tab === 'list') {
            tabs[0].classList.add('active');
            tabs[1].classList.remove('active');
            listView.style.display = 'block';
            editView.style.display = 'none';
        } else {
            tabs[0].classList.remove('active');
            tabs[1].classList.add('active');
            listView.style.display = 'none';
            editView.style.display = 'block';
        }
    }

    // Render element list
    function renderElementList() {
        const page = templateEditorState.pages.find(p => p.page_num === templateEditorState.currentPageNum);
        if (!page) return;

        const listView = document.getElementById('elementListView');

        if (page.shapes.length === 0) {
            listView.innerHTML = `
                <p style="color: var(--text-secondary); text-align: center; padding: var(--spacing-xl);">
                    è¯¥é¡µé¢æ²¡æœ‰å¯ç¼–è¾‘çš„å…ƒç´ 
                </p>
            `;
            return;
        }

        let html = '';

        page.shapes.forEach((shape, index) => {
            if (shape.is_hidden) return;

            const isNamed = shape.is_named;
            const isSelected = templateEditorState.canvasPreview?.selectedShapeId === shape.shape_id;

            html += `
                <div class="element-list-item ${isNamed ? 'named' : 'unnamed'} ${isSelected ? 'selected' : ''}"
                     onclick="selectElementFromList(${shape.shape_id})"
                     onmouseenter="highlightElement(${shape.shape_id})"
                     onmouseleave="unhighlightElement()">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                        <span style="font-weight: bold;">
                            ${isNamed ? 'âœ…' : 'âš ï¸'} #${index + 1}
                        </span>
                        <span style="font-size: 0.75rem; padding: 0.125rem 0.5rem; background: var(--bg-color); border-radius: 12px;">
                            ${shape.type === 'text' ? 'ğŸ“ æ–‡æœ¬' : 'ğŸ–¼ï¸ å›¾ç‰‡'}
                        </span>
                    </div>
                    <div style="font-size: 0.85rem; color: ${isNamed ? 'var(--text-primary)' : 'var(--text-secondary)'};">
                        ${shape.name || 'æœªå‘½å'}
                    </div>
                </div>
            `;
        });

        listView.innerHTML = html;
    }

    // Select element from list
    function selectElementFromList(shapeId) {
        const page = templateEditorState.pages.find(p => p.page_num === templateEditorState.currentPageNum);
        const shape = page.shapes.find(s => s.shape_id === shapeId);

        if (shape && templateEditorState.canvasPreview) {
            templateEditorState.canvasPreview.selectShape(shape);
            renderElementList();
            switchPropertyTab('edit');
            renderPropertyPanel(shape);
        }
    }

    // Highlight element on hover
    function highlightElement(shapeId) {
        if (templateEditorState.canvasPreview) {
            templateEditorState.canvasPreview.hoveredShapeId = shapeId;
            templateEditorState.canvasPreview.render();
        }
    }

    // Unhighlight element
    function unhighlightElement() {
        if (templateEditorState.canvasPreview) {
            templateEditorState.canvasPreview.hoveredShapeId = null;
            templateEditorState.canvasPreview.render();
        }
    }

    // Render property panel
    function renderPropertyPanel(shape) {
        const panel = document.getElementById('elementEditView');

        const shapeIndex = templateEditorState.pages
            .find(p => p.page_num === templateEditorState.currentPageNum)
            .shapes.findIndex(s => s.shape_id === shape.shape_id) + 1;

        panel.innerHTML = `
            <div style="margin-bottom: var(--spacing-lg);">
                <h4 style="margin-bottom: var(--spacing-md);">å…ƒç´  #${shapeIndex}</h4>

                <div class="form-group">
                    <label class="form-label">ç±»å‹</label>
                    <div style="padding: 0.5rem; background: var(--bg-color); border-radius: var(--radius-sm);">
                        ${shape.type === 'text' ? 'ğŸ“ æ–‡æœ¬æ¡†' : 'ğŸ–¼ï¸ å›¾ç‰‡'}
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label required">å…ƒç´ åç§°</label>
                    <input type="text" id="shapeNameInput" class="text-input"
                           value="${shape.name || ''}"
                           placeholder="ä¾‹å¦‚ï¼šæ ‡é¢˜åŒºã€ä½œè€…åã€ä¸»è¦å†…å®¹">
                    <small class="form-help">ä½¿ç”¨è¯­ä¹‰åŒ–åç§°ï¼Œæ–¹ä¾¿åç»­é…ç½®</small>
                </div>

                <div class="form-group">
                    <label class="form-label">ä½ç½®å’Œå°ºå¯¸</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.85rem;">
                        <div style="padding: 0.5rem; background: var(--bg-color); border-radius: var(--radius-sm);">
                            <div style="color: var(--text-secondary);">X</div>
                            <div>${Math.round(shape.left / 914400 * 2.54 * 10) / 10} cm</div>
                        </div>
                        <div style="padding: 0.5rem; background: var(--bg-color); border-radius: var(--radius-sm);">
                            <div style="color: var(--text-secondary);">Y</div>
                            <div>${Math.round(shape.top / 914400 * 2.54 * 10) / 10} cm</div>
                        </div>
                        <div style="padding: 0.5rem; background: var(--bg-color); border-radius: var(--radius-sm);">
                            <div style="color: var(--text-secondary);">å®½åº¦</div>
                            <div>${Math.round(shape.width / 914400 * 2.54 * 10) / 10} cm</div>
                        </div>
                        <div style="padding: 0.5rem; background: var(--bg-color); border-radius: var(--radius-sm);">
                            <div style="color: var(--text-secondary);">é«˜åº¦</div>
                            <div>${Math.round(shape.height / 914400 * 2.54 * 10) / 10} cm</div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button class="btn btn-primary btn-block" onclick="saveShapeName(${shape.shape_id})">
                        ğŸ’¾ ä¿å­˜åç§°
                    </button>
                    <button class="btn btn-${shape.is_hidden ? 'success' : 'secondary'} btn-block"
                            onclick="toggleShapeVisibility(${shape.shape_id})">
                        ${shape.is_hidden ? 'ğŸ‘ï¸ æ˜¾ç¤ºå…ƒç´ ' : 'ğŸ™ˆ éšè—å…ƒç´ '}
                    </button>
                </div>
            </div>
        `;
    }

    // ========================================
    // Element Actions
    // ========================================

    // Save shape name
    async function saveShapeName(shapeId) {
        const newName = document.getElementById('shapeNameInput').value.trim();

        if (!newName) {
            showWarning('è¯·è¾“å…¥å…ƒç´ åç§°');
            return;
        }

        // æ‰¾åˆ°å¯¹åº”çš„ shape
        const page = templateEditorState.pages.find(p => p.page_num === templateEditorState.currentPageNum);
        const shape = page.shapes.find(s => s.shape_id === shapeId);

        if (!shape) {
            showError('æ‰¾ä¸åˆ°å…ƒç´ ');
            return;
        }

        try {
            const response = await fetch('/developer-tools/update-shape-name/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    template_id: templateEditorState.templateId,
                    page_num: templateEditorState.currentPageNum,
                    shape_index: shape.shape_index,  // ä½¿ç”¨ shape_index è€Œä¸æ˜¯ shape_id
                    new_name: newName
                })
            });

            const data = await response.json();

            if (response.ok) {
                shape.name = newName;
                shape.is_named = true;

                templateEditorState.canvasPreview.updateShapes(page.shapes);
                renderElementList();
                renderPageList();
                updateProgress();

                showSuccess('âœ… åç§°å·²ä¿å­˜');
            } else {
                showError('ä¿å­˜å¤±è´¥: ' + data.error);
            }
        } catch (error) {
            showError('ä¿å­˜å¤±è´¥: ' + error.message);
        }
    }

    // Toggle shape visibility
    async function toggleShapeVisibility(shapeId) {
        const page = templateEditorState.pages.find(p => p.page_num === templateEditorState.currentPageNum);
        const shape = page.shapes.find(s => s.shape_id === shapeId);

        if (!shape) return;

        const newHiddenState = !shape.is_hidden;

        try {
            const response = await fetch('/developer-tools/toggle-shape-visibility/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    template_id: templateEditorState.templateId,
                    page_num: templateEditorState.currentPageNum,
                    shape_index: shape.shape_index,  // ä½¿ç”¨ shape_index è€Œä¸æ˜¯ shape_id
                    is_hidden: newHiddenState
                })
            });

            const data = await response.json();

            if (response.ok) {
                shape.is_hidden = newHiddenState;
                templateEditorState.canvasPreview.updateShapes(page.shapes);
                renderElementList();
                renderPageList();
                renderPropertyPanel(shape);
                updateProgress();

                showSuccess(newHiddenState ? 'å…ƒç´ å·²éšè—' : 'å…ƒç´ å·²æ˜¾ç¤º');
            } else {
                showError('æ“ä½œå¤±è´¥: ' + data.error);
            }
        } catch (error) {
            showError('æ“ä½œå¤±è´¥: ' + error.message);
        }
    }

    // Update progress
    function updateProgress() {
        let totalShapes = 0;
        let namedShapes = 0;

        templateEditorState.pages.forEach(page => {
            page.shapes.forEach(shape => {
                if (!shape.is_hidden) {
                    totalShapes++;
                    if (shape.is_named) {
                        namedShapes++;
                    }
                }
            });
        });

        const percent = totalShapes > 0 ? Math.round(namedShapes / totalShapes * 100) : 0;
        document.getElementById('namedCount').textContent = `${namedShapes} / ${totalShapes}`;
        document.getElementById('progressBar').style.width = percent + '%';
        document.getElementById('progressPercent').textContent = percent + '%';
    }

    // ========================================
    // Toolbar Actions
    // ========================================

    // Zoom controls
    document.getElementById('zoomInBtn')?.addEventListener('click', () => {
        templateEditorState.canvasPreview?.zoomIn();
    });

    document.getElementById('zoomOutBtn')?.addEventListener('click', () => {
        templateEditorState.canvasPreview?.zoomOut();
    });

    document.getElementById('fitToWindowBtn')?.addEventListener('click', () => {
        templateEditorState.canvasPreview?.fitToWindow();
    });

    // Upload new template
    document.getElementById('uploadNewBtn')?.addEventListener('click', () => {
        document.getElementById('uploadSection').style.display = 'block';
        document.getElementById('editorSection').style.display = 'none';
        document.getElementById('uploadTemplateForm').reset();
    });

    // Save PPT
    document.getElementById('saveTemplateBtn')?.addEventListener('click', async () => {
        if (!templateEditorState.templateId) {
            showWarning('æ²¡æœ‰å¯ä¿å­˜çš„æ¨¡æ¿');
            return;
        }

        try {
            showLoading('æ­£åœ¨ä¿å­˜ PPT...');

            const url = `/developer-tools/download-ppt/${templateEditorState.templateId}/`;
            const a = document.createElement('a');
            a.href = url;
            a.download = 'template.pptx';
            a.click();

            hideLoading();
            showSuccess('PPT å·²ä¿å­˜ï¼');
        } catch (error) {
            hideLoading();
            showError('ä¿å­˜å¤±è´¥: ' + error.message);
        }
    });

    // Generate config JSON
    document.getElementById('generateConfigBtn')?.addEventListener('click', async () => {
        if (!templateEditorState.templateId) {
            showWarning('æ²¡æœ‰å¯ç”Ÿæˆçš„é…ç½®');
            return;
        }

        try {
            showLoading('æ­£åœ¨ç”Ÿæˆé…ç½® JSON...');

            const response = await fetch('/developer-tools/generate-config/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    template_id: templateEditorState.templateId
                })
            });

            const data = await response.json();

            if (response.ok) {
                downloadJSON(data.config, 'template_config.json');
                hideLoading();
                showSuccess('é…ç½® JSON å·²ç”Ÿæˆï¼');
            } else {
                hideLoading();
                showError('ç”Ÿæˆå¤±è´¥: ' + data.error);
            }
        } catch (error) {
            hideLoading();
            showError('ç”Ÿæˆå¤±è´¥: ' + error.message);
        }
    });

    // ========================================
    // Keyboard Shortcuts
    // ========================================

    document.addEventListener('keydown', function (e) {
        // Ignore if typing in input
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            return;
        }

        // Ctrl+S: Save PPT
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            document.getElementById('saveTemplateBtn')?.click();
        }

        // Ctrl+G: Generate config
        if (e.ctrlKey && e.key === 'g') {
            e.preventDefault();
            document.getElementById('generateConfigBtn')?.click();
        }

        // Arrow keys: Switch pages
        if (e.key === 'ArrowLeft') {
            const prevPage = templateEditorState.currentPageNum - 1;
            if (prevPage >= 1) {
                loadPage(prevPage);
            }
        }
        if (e.key === 'ArrowRight') {
            const nextPage = templateEditorState.currentPageNum + 1;
            if (nextPage <= templateEditorState.pages.length) {
                loadPage(nextPage);
            }
        }

        // +/-: Zoom
        if (e.key === '+' || e.key === '=') {
            e.preventDefault();
            templateEditorState.canvasPreview?.zoomIn();
        }
        if (e.key === '-') {
            e.preventDefault();
            templateEditorState.canvasPreview?.zoomOut();
        }

        // 0: Fit to window
        if (e.key === '0') {
            e.preventDefault();
            templateEditorState.canvasPreview?.fitToWindow();
        }
    });

    // ========================================
    // File Upload UI Enhancement
    // ========================================

    document.getElementById('ppt_file')?.addEventListener('change', function () {
        const label = this.nextElementSibling;
        if (this.files.length > 0) {
            label.textContent = this.files[0].name;
        }
    });

    // ========================================
    // Property Tab Switching
    // ========================================

    document.querySelectorAll('.property-tab').forEach((tab, index) => {
        tab.addEventListener('click', () => {
            switchPropertyTab(index === 0 ? 'list' : 'edit');
        });
    });
</script>
{% endblock %}