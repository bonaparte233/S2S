{% extends 'base.html' %}
{% load static %}

{% block title %}é…ç½®æ¨¡æ¿ç”Ÿæˆ - å¼€å‘è€…å·¥å…·{% endblock %}

{% block extra_css %}
<style>
    .tool-header {
        display: flex;
        align-items: center;
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .tool-header-icon {
        width: 64px;
        height: 64px;
        border-radius: 16px;
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        flex-shrink: 0;
    }

    .tool-header-info h2 {
        margin: 0 0 var(--spacing-xs) 0;
    }

    .tool-header-info p {
        margin: 0;
        color: var(--text-secondary);
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.9rem;
        margin-bottom: var(--spacing-md);
        transition: color 0.2s;
    }

    .back-link:hover {
        color: var(--primary-color);
    }

    .file-upload-wrapper {
        position: relative;
        display: inline-block;
        width: 100%;
    }

    .file-upload-wrapper input[type="file"] {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
    }

    .file-upload-label {
        display: block;
        padding: var(--spacing-lg);
        border: 2px dashed var(--border-color);
        border-radius: var(--border-radius);
        text-align: center;
        background: var(--bg-secondary);
        transition: all 0.3s;
        cursor: pointer;
    }

    .file-upload-wrapper:hover .file-upload-label {
        border-color: var(--primary-color);
        background: var(--bg-hover);
    }

    .file-upload-label.has-file {
        border-color: var(--success-color);
        background: rgba(46, 204, 113, 0.1);
    }

    .result-card {
        margin-top: var(--spacing-lg);
    }

    .error-details {
        background: rgba(231, 76, 60, 0.1);
        padding: var(--spacing-md);
        border-radius: var(--border-radius);
        color: var(--danger-color);
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 0.85rem;
    }
</style>
{% endblock %}

{% block content %}
<a href="{% url 'developer_tools_page' %}" class="back-link">â† è¿”å›å¼€å‘è€…å·¥å…·</a>

<div class="tool-header">
    <div class="tool-header-icon">ğŸ“„</div>
    <div class="tool-header-info">
        <h2>é…ç½®æ¨¡æ¿ç”Ÿæˆ</h2>
        <p>ä¸Šä¼  PPT æ¨¡æ¿æ–‡ä»¶ï¼Œè‡ªåŠ¨æå–æ‰€æœ‰å¯ç¼–è¾‘å…ƒç´ å¹¶ç”Ÿæˆ JSON é…ç½®æ¨¡æ¿</p>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>ğŸ“¤ ä¸Šä¼  PPT æ¨¡æ¿æ–‡ä»¶</h3>
    </div>
    <div class="card-body">
        <form id="generateForm" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-group">
                <label for="template_file" class="form-label required">PPTæ¨¡æ¿æ–‡ä»¶</label>
                <div class="file-upload-wrapper">
                    <input type="file" id="template_file" name="template_file" accept=".pptx" required>
                    <span class="file-upload-label" id="fileLabel">ğŸ“‚ ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½ PPT æ¨¡æ¿æ–‡ä»¶ (.pptx)</span>
                </div>
            </div>
            <div class="form-group">
                <label for="mode" class="form-label">å¯¼å‡ºæ¨¡å¼</label>
                <select id="mode" name="mode" class="text-input">
                    <option value="semantic">è¯­ä¹‰æ¨¡å¼ - ä»…å¯¼å‡ºå‘½åè§„èŒƒçš„å…ƒç´ ï¼ˆæ¨èï¼‰</option>
                    <option value="text">æ–‡æœ¬æ¨¡å¼ - å¯¼å‡ºæ‰€æœ‰å¯ç¼–è¾‘æ–‡æœ¬æ¡†</option>
                </select>
                <small class="form-help">è¯­ä¹‰æ¨¡å¼åªå¯¼å‡ºåŒ…å«"xxåŒº"ç­‰å‘½åçš„å…ƒç´ </small>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-large" id="submitBtn">ğŸš€ ç”Ÿæˆé…ç½®æ¨¡æ¿</button>
            </div>
        </form>
    </div>
</div>

<div id="generateResult" class="card result-card" style="display: none;">
    <div class="card-header">
        <h3>âœ… ç”ŸæˆæˆåŠŸ</h3>
    </div>
    <div class="card-body">
        <p>é…ç½®æ¨¡æ¿å·²ç”Ÿæˆï¼ŒåŒ…å« <strong id="pageCount"></strong> ä¸ªé¡µé¢ã€‚</p>
        <div class="form-actions">
            <button id="downloadGeneratedBtn" class="btn btn-success">ğŸ“¥ ä¸‹è½½ JSON æ–‡ä»¶</button>
            <a href="{% url 'config_editor_page' %}" class="btn btn-primary">âœï¸ å‰å¾€ç¼–è¾‘</a>
        </div>
    </div>
</div>

<div id="generateError" class="card result-card" style="display: none;">
    <div class="card-header">
        <h3>âŒ ç”Ÿæˆå¤±è´¥</h3>
    </div>
    <div class="card-body">
        <div id="generateErrorContent" class="error-details"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let generatedData = null;

    document.getElementById('template_file').addEventListener('change', function () {
        const label = document.getElementById('fileLabel');
        if (this.files && this.files[0]) {
            label.textContent = 'ğŸ“„ ' + this.files[0].name;
            label.classList.add('has-file');
        } else {
            label.textContent = 'ğŸ“‚ ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½ PPT æ¨¡æ¿æ–‡ä»¶ (.pptx)';
            label.classList.remove('has-file');
        }
    });

    document.getElementById('generateForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const resultDiv = document.getElementById('generateResult');
        const errorDiv = document.getElementById('generateError');
        const submitBtn = document.getElementById('submitBtn');

        resultDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        submitBtn.disabled = true;
        submitBtn.textContent = 'â³ å¤„ç†ä¸­...';

        try {
            const response = await fetch('{% url "generate_config_template" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            const data = await response.json();

            if (response.ok) {
                generatedData = data;
                document.getElementById('pageCount').textContent = data.ppt_pages ? data.ppt_pages.length : 0;
                resultDiv.style.display = 'block';
            } else {
                let errorMsg = data.error || 'ç”Ÿæˆå¤±è´¥';
                if (data.traceback) {
                    errorMsg += '\n\nè¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š\n' + data.traceback;
                }
                document.getElementById('generateErrorContent').textContent = errorMsg;
                errorDiv.style.display = 'block';
            }
        } catch (error) {
            document.getElementById('generateErrorContent').textContent = 'ç½‘ç»œé”™è¯¯: ' + error.message;
            errorDiv.style.display = 'block';
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'ğŸš€ ç”Ÿæˆé…ç½®æ¨¡æ¿';
        }
    });

    document.getElementById('downloadGeneratedBtn').addEventListener('click', function () {
        if (!generatedData) return;
        const jsonStr = JSON.stringify(generatedData, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'ppt_config_template.json';
        a.click();
        URL.revokeObjectURL(url);
    });
</script>
{% endblock %}