{% extends 'base.html' %}

{% block title %}ç”Ÿæˆè¯¦æƒ… #{{ generation.id }} - S2S{% endblock %}

{% block content %}
<div class="page-header">
    <h2>ğŸ“Š ç”Ÿæˆè¯¦æƒ… #{{ generation.id }}</h2>
    <a href="{% url 'index' %}" class="btn btn-secondary">â† è¿”å›é¦–é¡µ</a>
</div>

<div class="grid-container">
    <!-- Status Card -->
    <div class="card card-primary">
        <div class="card-header">
            <h3>ğŸ“ˆ ç”ŸæˆçŠ¶æ€</h3>
        </div>
        <div class="card-body">
            <div class="status-display">
                <div class="status-badge status-{{ generation.status }}">
                    {{ generation.get_status_display }}
                </div>

                {% if generation.status == 'pending' %}
                <p class="status-message">å‡†å¤‡å¼€å§‹ç”Ÿæˆ...</p>
                <button id="startBtn" class="btn btn-primary btn-large">
                    ğŸš€ å¼€å§‹ç”Ÿæˆ
                </button>
                {% elif generation.status == 'processing' %}
                <div class="loading-spinner"></div>
                <p class="status-message">æ­£åœ¨ç”ŸæˆPPTï¼Œè¯·ç¨å€™...</p>
                {% elif generation.status == 'completed' %}
                <p class="status-message success">âœ… PPTç”ŸæˆæˆåŠŸï¼</p>
                <div class="download-actions">
                    <a href="{% url 'download_ppt' generation.pk %}" class="btn btn-success btn-large">
                        ğŸ“¥ ä¸‹è½½PPT
                    </a>
                    {% if is_developer %}
                    <a href="{% url 'download_config_json' generation.pk %}" class="btn btn-secondary" download>
                        ğŸ“„ ä¸‹è½½é…ç½®JSON
                    </a>
                    {% if has_preprocessed_script %}
                    <a href="{% url 'download_preprocessed_script' generation.pk %}" class="btn btn-info" download>
                        ğŸ“ ä¸‹è½½é¢„åˆ†é¡µè®²ç¨¿
                    </a>
                    {% endif %}
                    {% endif %}
                </div>
                {% elif generation.status == 'failed' %}
                <p class="status-message error">âŒ ç”Ÿæˆå¤±è´¥</p>
                {% if generation.error_message %}
                <div class="error-details">
                    <h4>é”™è¯¯è¯¦æƒ…ï¼š</h4>
                    <pre>{{ generation.error_message }}</pre>
                </div>
                {% endif %}
                <a href="{% url 'index' %}" class="btn btn-primary">
                    ğŸ”„ é‡æ–°ç”Ÿæˆ
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Details Card -->
    <div class="card">
        <div class="card-header">
            <h3>ğŸ“‹ é…ç½®ä¿¡æ¯</h3>
        </div>
        <div class="card-body">
            <div class="detail-list">
                <div class="detail-item">
                    <span class="detail-label">è®²ç¨¿æ–‡ä»¶ï¼š</span>
                    <span class="detail-value">{{ generation.docx_file.name|default:"æœªä¸Šä¼ " }}</span>
                </div>

                <div class="detail-item">
                    <span class="detail-label">æ¨¡æ¿ï¼š</span>
                    <span class="detail-value">
                        {% if generation.template_file %}
                        {{ generation.template_file.name }}
                        {% else %}
                        {{ generation.template_name|default:"é»˜è®¤æ¨¡æ¿" }}
                        {% endif %}
                    </span>
                </div>

                {% if generation.config_template_file %}
                <div class="detail-item">
                    <span class="detail-label">é…ç½®æ¨¡æ¿æ–‡ä»¶ï¼š</span>
                    <span class="detail-value">{{ generation.config_template_file.name }}</span>
                </div>
                {% elif generation.config_template %}
                <div class="detail-item">
                    <span class="detail-label">é…ç½®æ¨¡æ¿ï¼š</span>
                    <span class="detail-value">{{ generation.config_template }}</span>
                </div>
                {% endif %}



                <div class="detail-item">
                    <span class="detail-label">ä½¿ç”¨å¤§æ¨¡å‹ï¼š</span>
                    <span class="detail-value">
                        {% if generation.use_llm %}
                        âœ… æ˜¯
                        {% else %}
                        âŒ å¦
                        {% endif %}
                    </span>
                </div>

                {% if generation.course_name %}
                <div class="detail-item">
                    <span class="detail-label">è¯¾ç¨‹åç§°ï¼š</span>
                    <span class="detail-value">{{ generation.course_name }}</span>
                </div>
                {% endif %}

                {% if generation.college_name %}
                <div class="detail-item">
                    <span class="detail-label">å­¦é™¢åç§°ï¼š</span>
                    <span class="detail-value">{{ generation.college_name }}</span>
                </div>
                {% endif %}

                {% if generation.lecturer_name %}
                <div class="detail-item">
                    <span class="detail-label">è®²å¸ˆåç§°ï¼š</span>
                    <span class="detail-value">{{ generation.lecturer_name }}</span>
                </div>
                {% endif %}

                <div class="detail-item">
                    <span class="detail-label">åˆ›å»ºæ—¶é—´ï¼š</span>
                    <span class="detail-value">{{ generation.created_at|date:"Y-m-d H:i:s" }}</span>
                </div>

                {% if generation.completed_at %}
                <div class="detail-item">
                    <span class="detail-label">å®Œæˆæ—¶é—´ï¼š</span>
                    <span class="detail-value">{{ generation.completed_at|date:"Y-m-d H:i:s" }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const generationId = {{ generation.id }};
    const currentStatus = '{{ generation.status }}';

    // Auto-start if pending
    if (currentStatus === 'pending') {
        document.getElementById('startBtn').addEventListener('click', function () {
            startGeneration();
        });
    }

    // Poll status if processing
    if (currentStatus === 'processing') {
        pollStatus();
    }

    function startGeneration() {
        const btn = document.getElementById('startBtn');
        const statusDisplay = document.querySelector('.status-display');
        const statusBadge = document.querySelector('.status-badge');

        // Immediately show processing UI
        btn.disabled = true;
        btn.textContent = 'â³ å¯åŠ¨ä¸­...';

        fetch(`/generation/${generationId}/start/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update UI to show processing state
                    statusBadge.className = 'status-badge status-processing';
                    statusBadge.textContent = 'å¤„ç†ä¸­';

                    statusDisplay.innerHTML = `
                        <div class="status-badge status-processing">å¤„ç†ä¸­</div>
                        <div class="loading-spinner"></div>
                        <p class="status-message">æ­£åœ¨ç”ŸæˆPPTï¼Œè¯·ç¨å€™...</p>
                        <small style="color: var(--text-secondary);">è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…</small>
                    `;

                    // Start polling for status updates
                    pollStatus();
                } else {
                    // Show error and restore button
                    statusDisplay.innerHTML = `
                        <div class="status-badge status-failed">å¤±è´¥</div>
                        <p class="status-message error">âŒ å¯åŠ¨å¤±è´¥: ${data.error}</p>
                        <button id="startBtn" class="btn btn-primary btn-large">ğŸš€ é‡æ–°å¼€å§‹</button>
                    `;
                    document.getElementById('startBtn').addEventListener('click', startGeneration);
                }
            })
            .catch(error => {
                // Show error and restore button
                statusDisplay.innerHTML = `
                    <div class="status-badge status-failed">å¤±è´¥</div>
                    <p class="status-message error">âŒ è¯·æ±‚å¤±è´¥: ${error}</p>
                    <button id="startBtn" class="btn btn-primary btn-large">ğŸš€ é‡æ–°å¼€å§‹</button>
                `;
                document.getElementById('startBtn').addEventListener('click', startGeneration);
            });
    }

    function pollStatus() {
        const interval = setInterval(() => {
            fetch(`/generation/${generationId}/status/`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'completed' || data.status === 'failed') {
                        clearInterval(interval);
                        location.reload();
                    }
                });
        }, 2000);  // Poll every 2 seconds
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}